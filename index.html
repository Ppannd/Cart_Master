<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
    default-src * data: blob:;
    script-src * 'unsafe-inline' 'unsafe-eval' data: blob:;
    style-src * 'unsafe-inline' data:;
    img-src * data:;
    connect-src * data: blob:;
    frame-src * data:;
    font-src * data:;
">
    <title>CHART MASTER | Терминал трейдера</title>
    
    <!-- Supabase подключение -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Markdown библиотека для уроков -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- TradingView Widget -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Для современных браузеров (PNG версии) -->
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    
    <!-- Для устройств Apple (iPhone, iPad) -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Для Android (когда добавляют на главный экран) -->
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
    
    <!-- Манифест для PWA (Progressive Web App) -->
    <link rel="manifest" href="/site.webmanifest">
    
    <style>
        /* ===== ИМПОРТЫ ШРИФТОВ ===== */
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Темная тема */
            --bg-deep: #0A0C10;
            --bg-surface: #12141A;
            --bg-elevated: #1A1D26;
            --bg-card: #1E222D;
            --bg-highlight: #262B38;
            
            --text-primary: #FFFFFF;
            --text-secondary: #A0A8BA;
            --text-tertiary: #6E768E;
            --text-muted: #3D4357;
            
            --accent-1: #3A7BFF;
            --accent-2: #9F7AFF;
            --accent-3: #FF6B9D;
            --accent-4: #50E3C2;
            
            --gradient-primary: linear-gradient(135deg, #3A7BFF, #9F7AFF);
            --gradient-secondary: linear-gradient(135deg, #FF6B9D, #FFB56B);
            --gradient-success: linear-gradient(135deg, #50E3C2, #3A7BFF);
            --gradient-gold: linear-gradient(135deg, #FFD700, #FFA500);
            
            --border-light: rgba(255, 255, 255, 0.05);
            --border-medium: rgba(255, 255, 255, 0.1);
            
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.5);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.6);
            --shadow-lg: 0 16px 40px rgba(0, 0, 0, 0.8);
            --shadow-glow: 0 0 30px rgba(58, 123, 255, 0.3);
            --shadow-gold: 0 0 30px rgba(255, 215, 0, 0.3);
            
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Plus Jakarta Sans', sans-serif;
        }

        /* Светлая тема */
        .light-theme {
            --bg-deep: #F5F7FC;
            --bg-surface: #FFFFFF;
            --bg-elevated: #F0F3F8;
            --bg-card: #E8ECF5;
            --bg-highlight: #DCE1EC;
            
            --text-primary: #0A0C10;
            --text-secondary: #3A4157;
            --text-tertiary: #6E768E;
            --text-muted: #9BA5B9;
            
            --border-light: rgba(0, 0, 0, 0.05);
            --border-medium: rgba(0, 0, 0, 0.1);
            
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 8px 24px rgba(0, 0, 0, 0.04);
            --shadow-lg: 0 16px 40px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s, color 0.2s;
        }

        /* ===== АНИМАЦИЯ ЗАГРУЗКИ ===== */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-deep);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .splash-content {
            text-align: center;
            position: relative;
        }

        .chart-animation {
            position: relative;
            width: 400px;
            height: 200px;
            margin-bottom: 2rem;
        }

        .candle-container {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 8px;
        }

        .candle-animation {
            width: 20px;
            background: linear-gradient(180deg, var(--accent-1), #1E4B8F);
            border-radius: 3px 3px 0 0;
            animation: candleRise 1.5s ease infinite alternate;
            transform-origin: bottom;
            position: relative;
            box-shadow: 0 0 20px rgba(58, 123, 255, 0.3);
        }

        .candle-animation::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 5px;
            background: inherit;
            border-radius: 2px;
        }

        .candle-animation.red {
            background: linear-gradient(180deg, #FF6B9D, #B91C1C);
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.3);
        }

        @keyframes candleRise {
            0% {
                height: 40px;
            }
            100% {
                height: 120px;
            }
        }

        .candle-animation:nth-child(1) { animation-delay: 0s; height: 60px; }
        .candle-animation:nth-child(2) { animation-delay: 0.1s; height: 45px; background: var(--accent-3); }
        .candle-animation:nth-child(3) { animation-delay: 0.2s; height: 90px; }
        .candle-animation:nth-child(4) { animation-delay: 0.3s; height: 70px; }
        .candle-animation:nth-child(5) { animation-delay: 0.4s; height: 110px; }
        .candle-animation:nth-child(6) { animation-delay: 0.5s; height: 55px; background: var(--accent-3); }
        .candle-animation:nth-child(7) { animation-delay: 0.6s; height: 85px; }
        .candle-animation:nth-child(8) { animation-delay: 0.7s; height: 130px; }

        .grid-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(58, 123, 255, 0.2);
            animation: gridPulse 2s infinite;
        }

        @keyframes gridPulse {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.5; }
        }

        .grid-line:nth-child(1) { top: 25%; }
        .grid-line:nth-child(2) { top: 50%; }
        .grid-line:nth-child(3) { top: 75%; }

        .splash-title {
            font-size: 3.5rem;
            font-weight: 700;
            letter-spacing: -1px;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #FFFFFF, #A0A8BA);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0;
            animation: fadeUp 0.8s forwards 0.5s;
        }

        .splash-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            opacity: 0;
            animation: fadeUp 0.8s forwards 0.8s;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== ЭКРАН АВТОРИЗАЦИИ ===== */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: var(--bg-deep);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            pointer-events: none;
        }

        .auth-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .auth-container {
            width: 440px;
            position: relative;
        }

        .auth-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 40px;
            padding: 2.5rem;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }

        .auth-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(58, 123, 255, 0.1), transparent 70%);
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
            position: relative;
        }

        .auth-logo {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--bg-elevated);
            padding: 0.5rem;
            border-radius: 100px;
            position: relative;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 0.8rem;
            border-radius: 100px;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-secondary);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .auth-tab.active {
            color: white;
        }

        .auth-tab-bg {
            position: absolute;
            height: calc(100% - 1rem);
            width: calc(50% - 0.5rem);
            background: var(--gradient-primary);
            border-radius: 100px;
            top: 0.5rem;
            left: 0.5rem;
            transition: transform 0.3s ease;
            box-shadow: 0 0 20px var(--shadow-glow);
        }

        .auth-tabs.login-mode .auth-tab-bg {
            transform: translateX(0);
        }

        .auth-tabs.register-mode .auth-tab-bg {
            transform: translateX(100%);
        }

        .auth-form {
            position: relative;
        }

        .auth-form.hidden {
            display: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 1rem 1.2rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: var(--font-sans);
            transition: 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--accent-1);
            outline: none;
            box-shadow: 0 0 20px rgba(58, 123, 255, 0.3);
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 1rem;
            position: relative;
            overflow: hidden;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(58, 123, 255, 0.3);
        }

        .auth-btn.small {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            width: auto;
            margin-top: 0;
        }

        /* ===== ОСНОВНОЙ ИНТЕРФЕЙС ===== */
        .main-interface {
            min-height: 100vh;
            background: var(--bg-deep);
            display: none;
        }

        .main-interface.active {
            display: block;
        }

        /* КАБИНА ТРЕЙДЕРА */
        .cockpit {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            min-height: 100vh;
        }

        /* Левая панель */
        .left-panel {
            background: var(--bg-surface);
            border-right: 1px solid var(--border-medium);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            font-weight: 700;
            box-shadow: var(--shadow-glow);
        }

        .logo-text {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.3px;
        }

        .logo-text span {
            color: var(--accent-1);
        }

        /* Навигация */
        .nav-menu-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-item-vertical {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }

        .nav-item-vertical:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .nav-item-vertical.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .nav-icon {
            font-size: 1.3rem;
        }

        /* Профиль компактный */
        .profile-compact {
            margin-top: auto;
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 1.2rem;
            border: 1px solid var(--border-medium);
            cursor: pointer;
            transition: 0.2s;
        }

        .profile-compact:hover {
            border-color: var(--accent-1);
            transform: translateY(-2px);
        }

        .profile-compact-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .avatar-compact {
            width: 48px;
            height: 48px;
            background: var(--gradient-secondary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            font-weight: 600;
            overflow: hidden;
        }

        .level-compact {
            flex: 1;
        }

        .level-compact .label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
        }

        .level-compact .value {
            font-weight: 600;
        }

        .rank-compact {
            font-size: 0.8rem;
            color: var(--accent-2);
            margin-top: 0.2rem;
        }

        .xp-bar-compact {
            width: 100%;
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            overflow: hidden;
        }

        .xp-fill-compact {
            height: 100%;
            background: var(--gradient-primary);
        }

        /* Центральная панель */
        .center-panel {
            padding: 2rem;
            overflow-y: auto;
            max-height: 100vh;
        }

        /* Хедер */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .date-display {
            font-family: var(--font-mono);
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .settings-icon {
            width: 44px;
            height: 44px;
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.3rem;
            color: var(--text-secondary);
            transition: 0.2s;
        }

        .settings-icon:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        /* Секции */
        .section-container {
            display: none;
        }

        .section-container.active {
            display: block;
        }

        /* Дашборд */
        .welcome-block {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-surface));
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .welcome-block::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.1;
            filter: blur(40px);
        }

        .welcome-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .rank-badge {
            display: inline-block;
            background: var(--gradient-gold);
            padding: 0.3rem 1rem;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .quick-btn {
            background: var(--gradient-primary);
            border: none;
            border-radius: 20px;
            padding: 1.5rem;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            box-shadow: var(--shadow-glow);
            transition: 0.2s;
        }

        .quick-btn.secondary {
            background: var(--bg-surface);
            color: var(--text-primary);
            box-shadow: none;
            border: 1px solid var(--border-medium);
        }

        .quick-btn:hover {
            transform: translateY(-2px);
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 2.5rem;
        }

        .metric-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            padding: 1.2rem;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            color: var(--text-tertiary);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .metric-icon {
            width: 28px;
            height: 28px;
            background: var(--bg-elevated);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .metric-trend {
            color: var(--accent-4);
            font-size: 0.8rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .section-header h2 {
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* ===== ПОРТФЕЛЬ ===== */
        .portfolio-grid {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .portfolio-card.main-card {
            background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
            border-radius: 24px;
            padding: 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-glow);
        }

        .portfolio-balance {
            display: flex;
            flex-direction: column;
        }

        .balance-label {
            font-size: 0.85rem;
            text-transform: uppercase;
            opacity: 0.8;
            letter-spacing: 0.5px;
        }

        .balance-value {
            font-size: 2.5rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .balance-change {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 0.2rem;
        }

        .equity-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            opacity: 0.8;
        }

        .equity-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .portfolio-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .stat-item {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: 0.2s;
        }

        .stat-item:hover {
            border-color: var(--accent-1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: var(--bg-elevated);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-label {
            color: var(--text-tertiary);
            font-size: 0.8rem;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-1);
        }

        .portfolio-section {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 1.5rem;
        }

        .portfolio-section h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1.2rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .assets-distribution {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .asset-row {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .asset-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-elevated);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .asset-info {
            flex: 1;
        }

        .asset-name {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .asset-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 0.2rem;
        }

        .asset-progress {
            width: 100%;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.3rem;
        }

        .asset-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-4), var(--accent-1));
            border-radius: 2px;
        }

        .best-trade {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 1rem;
        }

        .best-trade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .best-trade-asset {
            font-weight: 600;
            color: var(--accent-1);
        }

        .best-trade-profit {
            font-weight: 700;
        }

        .best-trade-profit.positive {
            color: var(--accent-4);
        }

        .best-trade-profit.negative {
            color: var(--accent-3);
        }

        .best-trade-details {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .recent-move-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .recent-move-item:last-child {
            border-bottom: none;
        }

        .move-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-elevated);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .move-info {
            flex: 1;
        }

        .move-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .move-time {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .move-value {
            font-weight: 600;
        }

        .move-value.positive {
            color: var(--accent-4);
        }

        .move-value.negative {
            color: var(--accent-3);
        }

        /* Терминал */
        .terminal-section {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 1.5rem;
            height: calc(100vh - 150px);
        }

        .chart-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .asset-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 12px;
        }

        .asset-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .asset-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        #tv_widget {
            width: 100%;
            flex: 1;
            min-height: 400px;
        }

        .trading-panel {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }

        .margin-info {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .margin-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .margin-label {
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .margin-value {
            font-weight: 600;
        }

        .margin-value.used {
            color: var(--accent-2);
        }

        .margin-value.free {
            color: var(--accent-4);
        }

        .margin-divider {
            height: 1px;
            background: var(--border-light);
            margin: 0.5rem 0;
        }

        .direction-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .direction-btn {
            flex: 1;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .direction-btn.long {
            background: var(--accent-4);
            color: #000;
        }

        .direction-btn.long.active {
            box-shadow: 0 0 20px var(--accent-4);
            transform: scale(1.02);
        }

        .direction-btn.short {
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }

        .direction-btn.short.active {
            background: var(--accent-3);
            color: white;
            box-shadow: 0 0 20px var(--accent-3);
        }

        .trade-input-group {
            margin-bottom: 1rem;
        }

        .trade-input-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        .trade-input {
            width: 100%;
            padding: 0.8rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .leverage-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .leverage-btn {
            flex: 1;
            min-width: 60px;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
        }

        .leverage-btn.active {
            background: var(--gradient-primary);
            color: white;
            border-color: transparent;
        }

        .calculate-info {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .calc-label {
            color: var(--text-tertiary);
        }

        .calc-value {
            font-weight: 600;
        }

        .calc-value.profit {
            color: var(--accent-4);
        }

        .calc-value.loss {
            color: var(--accent-3);
        }

        .open-trade-btn {
            width: 100%;
            padding: 1rem;
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 1rem;
        }

        .open-trade-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .positions-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
        }

        .positions-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .position-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            padding: 1rem;
            margin-bottom: 0.8rem;
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .position-direction {
            font-weight: 600;
        }

        .position-direction.long {
            color: var(--accent-4);
        }

        .position-direction.short {
            color: var(--accent-3);
        }

        .position-asset {
            color: var(--text-tertiary);
            font-size: 0.8rem;
        }

        .position-close {
            padding: 0.3rem 0.8rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 8px;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: 0.2s;
        }

        .position-close:hover {
            background: var(--accent-3);
            color: white;
        }

        .position-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .position-pnl {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-medium);
            text-align: right;
        }

        .pnl-positive {
            color: var(--accent-4);
            font-weight: 600;
        }

        .pnl-negative {
            color: var(--accent-3);
            font-weight: 600;
        }

        /* ===== ТРЕНАЖЕР ===== */
        .trainer-new-container {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 32px;
            padding: 2rem;
            margin: 1rem 0;
        }

        .trainer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .trainer-title h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.3rem;
        }

        .trainer-title p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .trainer-stats {
            display: flex;
            gap: 2rem;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        .chart-wrapper {
            background: var(--bg-elevated);
            border-radius: 24px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        #trainerCanvas {
            width: 100%;
            height: auto;
            background: var(--bg-deep);
            border-radius: 16px;
            display: block;
            cursor: crosshair;
        }

        .animation-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .anim-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            color: var(--text-secondary);
            font-size: 1.3rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .anim-btn:hover {
            background: var(--accent-1);
            color: white;
            transform: scale(1.1);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .slider-label {
            color: var(--text-tertiary);
            font-size: 0.9rem;
            min-width: 60px;
        }

        #candleSlider {
            flex: 1;
            height: 4px;
            background: var(--bg-elevated);
            border-radius: 2px;
            -webkit-appearance: none;
        }

        #candleSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: var(--accent-1);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-glow);
        }

        .task-info {
            background: var(--bg-elevated);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-badge {
            background: var(--accent-1);
            color: white;
            padding: 0.5rem 1.2rem;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .answer-buttons-new {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .answer-btn-new {
            flex: 1;
            padding: 1.2rem;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .answer-btn-new.long {
            background: var(--accent-4);
            color: #000;
        }

        .answer-btn-new.short {
            background: var(--accent-3);
            color: white;
        }

        .answer-btn-new:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .result-message {
            text-align: center;
            padding: 1rem;
            border-radius: 16px;
            margin: 1rem 0;
            font-weight: 600;
            animation: slideIn 0.3s ease;
        }

        .result-message.correct {
            background: rgba(80, 227, 194, 0.2);
            color: var(--accent-4);
            border: 1px solid var(--accent-4);
        }

        .result-message.wrong {
            background: rgba(255, 107, 157, 0.2);
            color: var(--accent-3);
            border: 1px solid var(--accent-3);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .next-btn-new {
            width: 100%;
            padding: 1.2rem;
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            margin-top: 1rem;
        }

        .next-btn-new:hover {
            background: var(--accent-1);
            border-color: var(--accent-1);
        }

        /* ===== ОБУЧЕНИЕ ===== */
        .learning-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
        }

        .back-button {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            padding: 0.8rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: 0.2s;
        }

        .back-button:hover {
            background: var(--bg-highlight);
            color: var(--text-primary);
            border-color: var(--accent-1);
        }

        .back-button.hidden {
            display: none;
        }

        .main-course {
            background: var(--gradient-primary);
            border-radius: 32px;
            padding: 2rem;
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: 0.2s;
        }

        .main-course:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .main-course::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: rgba(255,255,255,0.1);
            transform: skewX(-15deg);
        }

        .main-course h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .main-course p {
            opacity: 0.9;
            margin-bottom: 1.5rem;
            max-width: 500px;
        }

        .main-course-progress {
            max-width: 400px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
        }

        .thematic-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .thematic-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 1.5rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .thematic-card:hover {
            border-color: var(--accent-1);
            transform: translateY(-4px);
        }

        .thematic-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .thematic-card h3 {
            font-size: 1rem;
            margin-bottom: 0.3rem;
        }

        .thematic-card p {
            color: var(--text-tertiary);
            font-size: 0.8rem;
        }

        .course-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .course-description {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .chapters-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .chapter-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 1.5rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .chapter-card:hover {
            border-color: var(--accent-4);
            transform: translateX(5px);
        }

        .chapter-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent-2);
        }

        .chapter-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .lessons-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-top: 0.5rem;
        }

        .lesson-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            padding: 1rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lesson-item:hover:not(.locked) {
            border-color: var(--accent-4);
            transform: translateX(5px);
        }

        .lesson-item.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .lesson-item.completed {
            border-color: var(--accent-4);
            background: rgba(80, 227, 194, 0.05);
        }

        .lesson-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lesson-icon {
            font-size: 1.5rem;
        }

        .lesson-title {
            font-size: 1rem;
            font-weight: 500;
        }

        .lesson-meta {
            color: var(--text-tertiary);
            font-size: 0.8rem;
            margin-top: 0.2rem;
        }

        .lesson-badge {
            background: var(--accent-1);
            padding: 0.2rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .completed-badge {
            color: var(--accent-4);
            font-size: 1.2rem;
        }

        .lesson-content {
            line-height: 1.7;
            color: var(--text-primary);
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            padding: 2rem;
            margin: 1rem 0 2rem;
        }

        .lesson-content h1 {
            font-size: 2rem;
            margin: 1.5rem 0 1rem;
            color: var(--accent-1);
        }

        .lesson-content h2 {
            font-size: 1.5rem;
            margin: 1.2rem 0 0.8rem;
        }

        .lesson-content p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .lesson-content ul, .lesson-content ol {
            margin: 1rem 0;
            padding-left: 2rem;
            color: var(--text-secondary);
        }

        .lesson-content blockquote {
            border-left: 4px solid var(--accent-1);
            background: var(--bg-elevated);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            border-radius: 0 12px 12px 0;
            font-style: italic;
        }

        .lesson-content img {
            max-width: 100%;
            border-radius: 12px;
            margin: 1rem 0;
            border: 1px solid var(--border-medium);
        }

        .mark-complete-btn {
            background: var(--gradient-success);
            border: none;
            border-radius: 16px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 2rem;
            transition: 0.2s;
            width: 100%;
        }

        .mark-complete-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .mark-complete-btn.completed {
            background: var(--bg-elevated);
            color: var(--accent-4);
            cursor: default;
        }

        .mark-complete-btn.completed:hover {
            transform: none;
            box-shadow: none;
        }

        .loading-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-tertiary);
        }

        .loading-state div:first-child {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* ===== ДРУЗЬЯ ===== */
        .friends-header {
            margin-bottom: 2rem;
        }

        .friends-header h2 {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .friends-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            background: var(--bg-elevated);
            padding: 0.5rem;
            border-radius: 100px;
        }

        .friends-tab {
            flex: 1;
            text-align: center;
            padding: 0.8rem;
            border-radius: 100px;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .friends-tab.active {
            background: var(--gradient-primary);
            color: white;
        }

        .friends-search {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .friends-search input {
            flex: 1;
            padding: 0.8rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .friends-search button {
            padding: 0.8rem 1.5rem;
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        .friends-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .friend-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            padding: 1.2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: 0.2s;
        }

        .friend-card:hover {
            border-color: var(--accent-1);
        }

        .friend-avatar {
            width: 60px;
            height: 60px;
            background: var(--gradient-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 600;
            overflow: hidden;
        }

        .friend-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .friend-info {
            flex: 1;
        }

        .friend-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .friend-username {
            color: var(--accent-2);
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .friend-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .friend-actions {
            display: flex;
            gap: 0.5rem;
        }

        .friend-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .friend-btn.add {
            background: var(--gradient-primary);
            color: white;
        }

        .friend-btn.remove {
            background: var(--bg-elevated);
            color: var(--accent-3);
            border: 1px solid var(--border-medium);
        }

        .friend-btn.accept {
            background: var(--accent-4);
            color: #000;
        }

        .friend-btn.decline {
            background: var(--bg-elevated);
            color: var(--accent-3);
        }

        /* Дружеский забег */
        .race-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .race-period {
            background: var(--bg-elevated);
            padding: 0.5rem 1rem;
            border-radius: 40px;
            font-size: 0.9rem;
        }

        .leaderboard {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 24px;
            overflow: hidden;
        }

        .leaderboard-header {
            display: grid;
            grid-template-columns: 80px 1fr 120px 120px;
            padding: 1rem;
            background: var(--bg-elevated);
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-medium);
        }

        .leaderboard-row {
            display: grid;
            grid-template-columns: 80px 1fr 120px 120px;
            padding: 1rem;
            align-items: center;
            border-bottom: 1px solid var(--border-light);
            cursor: pointer;
            transition: 0.2s;
        }

        .leaderboard-row:hover {
            background: var(--bg-elevated);
        }

        .leaderboard-row.current-user {
            background: rgba(58, 123, 255, 0.1);
        }

        .rank {
            font-weight: 700;
            font-size: 1.2rem;
        }

        .rank-1 {
            color: gold;
        }

        .rank-2 {
            color: silver;
        }

        .rank-3 {
            color: #cd7f32;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .user-avatar-small {
            width: 40px;
            height: 40px;
            background: var(--gradient-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .user-avatar-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-name {
            font-weight: 500;
        }

        .user-username {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .stat-value {
            font-weight: 600;
        }

        .stat-value.accent {
            color: var(--accent-4);
        }

        .empty-state {
            color: var(--text-tertiary);
            text-align: center;
            padding: 3rem;
            font-size: 1rem;
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .invite-btn {
            background: var(--gradient-primary);
            border: none;
            border-radius: 16px;
            padding: 0.8rem 2rem;
            color: white;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* ===== ПРОФИЛЬ ===== */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1.5rem;
        }

        .profile-card {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 32px;
            padding: 2rem;
            text-align: center;
        }

        .avatar-upload {
            position: relative;
            margin-bottom: 1.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .profile-avatar-large {
            width: 120px;
            height: 120px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 600;
            margin: 0 auto 1rem;
            box-shadow: var(--shadow-glow);
            cursor: pointer;
            transition: 0.2s;
            border: 3px solid transparent;
            overflow: hidden;
        }

        .profile-avatar-large:hover {
            transform: scale(1.05);
            border-color: var(--accent-1);
        }

        .profile-avatar-large img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-upload-btn {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 40px;
            padding: 0.5rem 1rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .avatar-upload-btn:hover {
            background: var(--accent-1);
            color: white;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.3rem;
        }

        .profile-username {
            color: var(--accent-2);
            font-size: 1rem;
            margin-bottom: 1rem;
            font-family: var(--font-mono);
        }

        .profile-rank {
            display: inline-block;
            background: var(--gradient-gold);
            padding: 0.3rem 1rem;
            border-radius: 40px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .profile-invite {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 1rem;
            margin: 1.5rem 0;
            text-align: left;
        }

        .invite-label {
            color: var(--text-tertiary);
            font-size: 0.8rem;
            text-transform: uppercase;
            display: block;
            margin-bottom: 0.5rem;
        }

        .invite-code {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            padding: 0.8rem 1rem;
            cursor: pointer;
            transition: 0.2s;
            font-family: var(--font-mono);
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .invite-code:hover {
            border-color: var(--accent-1);
            background: var(--bg-elevated);
        }

        .copy-icon {
            font-size: 1.2rem;
            opacity: 0.7;
        }

        .profile-level-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
            padding: 0.5rem;
            background: var(--bg-elevated);
            border-radius: 40px;
        }

        .level-badge {
            background: var(--gradient-primary);
            padding: 0.3rem 1rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .xp-info {
            color: var(--text-secondary);
            padding-right: 1rem;
            font-size: 0.9rem;
        }

        .profile-bio {
            margin: 1.5rem 0;
        }

        .profile-bio textarea {
            width: 100%;
            padding: 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.95rem;
            resize: vertical;
            transition: 0.2s;
        }

        .profile-bio textarea:focus {
            border-color: var(--accent-1);
            outline: none;
            box-shadow: 0 0 20px rgba(58, 123, 255, 0.3);
        }

        .profile-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 1.5rem;
        }

        .profile-actions button {
            flex: 1;
            padding: 0.8rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .edit-profile-btn {
            background: var(--gradient-primary);
            color: white;
        }

        .logout-btn {
            background: var(--bg-elevated);
            color: var(--accent-3);
            border: 1px solid var(--border-medium) !important;
        }

        .logout-btn:hover {
            background: var(--accent-3);
            color: white;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            padding: 1.5rem 0;
            border-top: 1px solid var(--border-medium);
            border-bottom: 1px solid var(--border-medium);
            margin-bottom: 1.5rem;
        }

        .profile-stat {
            text-align: center;
        }

        .profile-stat .value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--accent-1);
        }

        .profile-stat .label {
            color: var(--text-tertiary);
            font-size: 0.8rem;
        }

        /* ===== ДОСТИЖЕНИЯ ===== */
        .achievements-section {
            margin-top: 2rem;
        }

        .achievements-section h3 {
            margin-bottom: 1rem;
            color: var(--accent-2);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.8rem;
            margin-bottom: 1rem;
        }

        .achievement-square {
            aspect-ratio: 1 / 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            cursor: help;
            transition: 0.2s;
            position: relative;
        }

        .achievement-square.earned {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
            border-color: gold;
        }

        .achievement-square:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .achievement-icon {
            font-size: 2rem;
            margin-bottom: 0.2rem;
        }

        .achievement-name {
            font-size: 0.6rem;
            text-align: center;
            color: var(--text-secondary);
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .achievement-square.earned .achievement-name {
            color: gold;
        }

        .achievement-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            padding: 0.8rem;
            font-size: 0.8rem;
            white-space: normal;
            display: none;
            z-index: 100;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            max-width: 250px;
            margin-bottom: 0.5rem;
        }

        .achievement-square:hover .achievement-tooltip {
            display: block;
        }

        .tooltip-title {
            font-weight: 600;
            color: var(--accent-1);
            margin-bottom: 0.3rem;
        }

        .tooltip-desc {
            color: var(--text-secondary);
            margin-bottom: 0.3rem;
        }

        .tooltip-xp {
            color: var(--accent-4);
            font-weight: 600;
        }

        .tooltip-date {
            color: var(--text-tertiary);
            font-size: 0.7rem;
            margin-top: 0.3rem;
        }

        .tooltip-progress {
            color: var(--text-tertiary);
            font-size: 0.7rem;
            margin-top: 0.3rem;
        }

        .category-title {
            font-size: 1rem;
            color: var(--accent-2);
            margin: 1.5rem 0 0.5rem 0;
        }

        /* Правая панель */
        .right-panel {
            background: var(--bg-surface);
            border-left: 1px solid var(--border-medium);
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            overflow-y: auto;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .activity-header h3 {
            font-size: 1rem;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem;
            background: var(--bg-elevated);
            border-radius: 16px;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .activity-details {
            flex: 1;
        }

        .activity-title {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .activity-time {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .activity-xp {
            color: var(--accent-4);
            font-weight: 600;
        }

        .streak-card {
            background: linear-gradient(135deg, var(--bg-elevated), var(--bg-card));
            border-radius: 24px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .streak-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent-3);
        }

        .streak-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .streak-days {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-3);
            line-height: 1;
        }

        .friends-online {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .friend-online {
            width: 40px;
            height: 40px;
            background: var(--gradient-secondary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .friend-online img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .ticker {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            padding: 1rem;
        }

        .ticker-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-medium);
        }

        .ticker-item:last-child {
            border-bottom: none;
        }

        .ticker-pair {
            font-weight: 500;
        }

        .ticker-price {
            font-family: var(--font-mono);
        }

        .ticker-change {
            color: var(--accent-4);
        }

        .ticker-change.negative {
            color: var(--accent-3);
        }

        .tip-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 20px;
            padding: 1.2rem;
        }

        .tip-title {
            color: var(--accent-2);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .tip-content {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* ===== УВЕДОМЛЕНИЯ ===== */
        .notification-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            padding: 1rem;
            box-shadow: var(--shadow-lg);
            animation: notificationSlideIn 0.3s ease;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification.success {
            border-color: var(--accent-4);
            background: linear-gradient(135deg, var(--bg-surface), rgba(80, 227, 194, 0.1));
        }

        .notification.warning {
            border-color: var(--accent-3);
            background: linear-gradient(135deg, var(--bg-surface), rgba(255, 107, 157, 0.1));
        }

        .notification.achievement {
            border-color: gold;
            background: linear-gradient(135deg, var(--bg-surface), rgba(255, 215, 0, 0.1));
        }

        .notification-icon {
            font-size: 2rem;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 0.2rem;
        }

        .notification-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        @keyframes notificationSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes notificationSlideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* ===== МОДАЛЬНЫЕ ОКНА ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-surface);
            border: 1px solid var(--border-medium);
            border-radius: 32px;
            padding: 2rem;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalAppear 0.3s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-medium);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            font-weight: 600;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 2rem;
            cursor: pointer;
            transition: 0.2s;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .settings-group {
            margin-bottom: 2rem;
        }

        .settings-group label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .theme-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-elevated);
            padding: 0.25rem;
            border-radius: 100px;
            border: 1px solid var(--border-medium);
        }

        .theme-option {
            flex: 1;
            padding: 0.8rem;
            text-align: center;
            border-radius: 100px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .theme-option.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .language-select {
            width: 100%;
            padding: 0.8rem 1rem;
            background: var(--bg-elevated);
            border: 1px solid var(--border-medium);
            border-radius: 16px;
            color: var(--text-primary);
            font-family: var(--font-sans);
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .language-select:focus {
            border-color: var(--accent-1);
            outline: none;
            box-shadow: 0 0 20px rgba(58, 123, 255, 0.3);
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: 0.2s;
        }

        .checkbox-label:hover {
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-1);
            cursor: pointer;
        }

        /* Адаптивность */
        @media (max-width: 1200px) {
            .cockpit {
                grid-template-columns: 240px 1fr 260px;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .thematic-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .achievements-grid {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .terminal-section {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .portfolio-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .cockpit {
                grid-template-columns: 1fr;
            }
            
            .left-panel, .right-panel {
                display: none;
            }
            
            .achievements-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .portfolio-card.main-card {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <!-- Сплаш (анимация при заходе) -->
    <div class="splash-screen" id="splash">
        <div class="splash-content">
            <div class="chart-animation">
                <div class="grid-line"></div>
                <div class="grid-line"></div>
                <div class="grid-line"></div>
                <div class="candle-container">
                    <div class="candle-animation"></div>
                    <div class="candle-animation red"></div>
                    <div class="candle-animation"></div>
                    <div class="candle-animation"></div>
                    <div class="candle-animation red"></div>
                    <div class="candle-animation"></div>
                    <div class="candle-animation"></div>
                    <div class="candle-animation red"></div>
                </div>
            </div>
            <h1 class="splash-title">CHART MASTER</h1>
            <div class="splash-subtitle">ТЕРМИНАЛ ТРЕЙДЕРА</div>
        </div>
    </div>

    <!-- Контейнер для уведомлений -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Экран авторизации -->
    <div class="auth-screen" id="auth">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="auth-logo">CM</div>
                    <p style="color: var(--text-secondary);">Доступ к терминалу</p>
                </div>
                
                <div class="auth-tabs login-mode" id="authTabs">
                    <div class="auth-tab active" onclick="switchAuthTab('login')">Вход</div>
                    <div class="auth-tab" onclick="switchAuthTab('register')">Регистрация</div>
                    <div class="auth-tab-bg"></div>
                </div>

                <!-- Форма входа -->
                <div class="auth-form" id="loginForm">
                    <div class="form-group">
                        <label>EMAIL</label>
                        <input type="email" placeholder="your@email.com" id="loginEmail">
                    </div>
                    <div class="form-group">
                        <label>ПАРОЛЬ</label>
                        <input type="password" placeholder="••••••••" id="loginPassword">
                    </div>
                    <button class="auth-btn" onclick="handleLogin()">ВОЙТИ В ТЕРМИНАЛ</button>
                    <div id="loginError" style="color: var(--accent-3); margin-top: 0.5rem; text-align: center;"></div>
                </div>

                <!-- Форма регистрации -->
                <div class="auth-form hidden" id="registerForm">
                    <div class="form-group">
                        <label>ИМЯ</label>
                        <input type="text" placeholder="Александр" id="registerName">
                    </div>
                    <div class="form-group">
                        <label>EMAIL</label>
                        <input type="email" placeholder="your@email.com" id="registerEmail">
                    </div>
                    <div class="form-group">
                        <label>ПАРОЛЬ</label>
                        <input type="password" placeholder="••••••••" id="registerPassword">
                    </div>
                    <div class="form-group">
                        <label>УРОВЕНЬ ОПЫТА</label>
                        <select id="registerLevel">
                            <option>Начинающий (0-3 месяца)</option>
                            <option>Средний (3-12 месяцев)</option>
                            <option>Продвинутый (более года)</option>
                        </select>
                    </div>
                    <button class="auth-btn" onclick="handleRegister()">СОЗДАТЬ АККАУНТ</button>
                    <div id="registerError" style="color: var(--accent-3); margin-top: 0.5rem; text-align: center;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основной интерфейс -->
    <div class="main-interface" id="mainInterface">
        <div class="cockpit">
            <!-- Левая панель -->
            <div class="left-panel">
                <div class="logo-area">
                    <div class="logo-icon">📈</div>
                    <div class="logo-text">CHART<span>MASTER</span></div>
                </div>

                <div class="nav-menu-vertical">
                    <div class="nav-item-vertical active" onclick="switchSection('dashboard')">
                        <span class="nav-icon">📊</span>
                        <span>Дашборд</span>
                    </div>
                    <div class="nav-item-vertical" onclick="switchSection('terminal')">
                        <span class="nav-icon">📈</span>
                        <span>Терминал</span>
                    </div>
                    <div class="nav-item-vertical" onclick="switchSection('trainer')">
                        <span class="nav-icon">🎯</span>
                        <span>Тренажер</span>
                    </div>
                    <div class="nav-item-vertical" onclick="switchSection('learning')">
                        <span class="nav-icon">📚</span>
                        <span>Обучение</span>
                    </div>
                    <div class="nav-item-vertical" onclick="switchSection('friends')">
                        <span class="nav-icon">👥</span>
                        <span>Дружеский забег</span>
                    </div>
                    <div class="nav-item-vertical" onclick="switchSection('profile')">
                        <span class="nav-icon">👤</span>
                        <span>Профиль</span>
                    </div>
                    <div class="nav-item-vertical" onclick="openAchievementsModal()">
                        <span class="nav-icon">🏆</span>
                        <span>Достижения</span>
                    </div>
                </div>

                <div class="profile-compact" onclick="switchSection('profile')">
                    <div class="profile-compact-header">
                        <div class="avatar-compact" id="compactAvatar">A</div>
                        <div class="level-compact">
                            <div class="label">УРОВЕНЬ</div>
                            <div class="value" id="compactLevel">Загрузка...</div>
                            <div class="rank-compact" id="compactRank">Новичок</div>
                        </div>
                    </div>
                    <div class="xp-bar-compact">
                        <div class="xp-fill-compact" id="compactXpBar" style="width: 0%;"></div>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; color: var(--text-tertiary); font-size: 0.75rem;">
                        <span id="compactXp">0 XP</span>
                        <span id="compactXpNext">→ 1000 XP</span>
                    </div>
                </div>
            </div>

            <!-- Центральная панель -->
            <div class="center-panel">
                <!-- Хедер -->
                <div class="dashboard-header">
                    <div class="date-display" id="currentDate"></div>
                    <div class="header-actions">
                        <div class="settings-icon" onclick="openSettings()">⚙️</div>
                    </div>
                </div>

                <!-- Раздел 1: Дашборд -->
                <div id="dashboard-section" class="section-container active">
                    <div class="welcome-block">
                        <h1 class="welcome-title" id="welcomeName">С возвращением, <span id="userName">Трейдер</span></h1>
                        <p class="welcome-subtitle" id="welcomeMessage">Ваш портфель растет. Продолжайте в том же духе!</p>
                        <div class="rank-badge" id="dashboardRank">Новичок</div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-btn" onclick="switchToTerminal()">
                            📈 Перейти в терминал
                        </button>
                        <button class="quick-btn secondary" onclick="switchToLearning()">
                            📚 Продолжить обучение
                        </button>
                    </div>

                    <div class="metrics-grid" id="dashboardMetrics">
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Тренировки</span>
                                <span class="metric-icon">📋</span>
                            </div>
                            <div class="metric-value" id="metricTrainings">0</div>
                            <div class="metric-trend" id="metricTrainingsTrend">загрузка...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Точность</span>
                                <span class="metric-icon">🎯</span>
                            </div>
                            <div class="metric-value" id="metricAccuracy">0%</div>
                            <div class="metric-trend" id="metricAccuracyTrend">загрузка...</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Баланс</span>
                                <span class="metric-icon">💰</span>
                            </div>
                            <div class="metric-value" id="metricBalance">$10,000</div>
                            <div class="metric-trend" id="metricBalanceTrend">демо-счет</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-header">
                                <span class="metric-label">Достижения</span>
                                <span class="metric-icon">🏆</span>
                            </div>
                            <div class="metric-value" id="metricAchievements">0</div>
                            <div class="metric-trend" id="metricAchievementsTrend">из 43</div>
                        </div>
                    </div>

                    <!-- ПОРТФЕЛЬ -->
                    <div class="section-header">
                        <h2>📊 Мой портфель</h2>
                        <span style="color: var(--accent-4);" id="portfolioUpdateTime">только что</span>
                    </div>

                    <div class="portfolio-grid">
                        <div class="portfolio-card main-card">
                            <div class="portfolio-balance">
                                <span class="balance-label">Баланс</span>
                                <span class="balance-value" id="portfolioBalance">$10,000</span>
                                <span class="balance-change" id="portfolioChange">+0.00%</span>
                            </div>
                            <div class="portfolio-equity">
                                <span class="equity-label">Эквити</span>
                                <span class="equity-value" id="portfolioEquity">$10,000</span>
                            </div>
                        </div>

                        <div class="portfolio-stats-grid">
                            <div class="stat-item">
                                <div class="stat-icon">📈</div>
                                <div class="stat-info">
                                    <span class="stat-label">Открыто сделок</span>
                                    <span class="stat-value" id="openTradesCount">0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">💰</div>
                                <div class="stat-info">
                                    <span class="stat-label">Общий объем</span>
                                    <span class="stat-value" id="totalVolume">$0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">💵</div>
                                <div class="stat-info">
                                    <span class="stat-label">Маржа</span>
                                    <span class="stat-value" id="totalMargin">$0</span>
                                </div>
                            </div>
                            
                            <div class="stat-item">
                                <div class="stat-icon">📊</div>
                                <div class="stat-info">
                                    <span class="stat-label">P&L</span>
                                    <span class="stat-value" id="totalPNL">$0</span>
                                </div>
                            </div>
                        </div>

                        <div class="portfolio-section">
                            <h3>Распределение по активам</h3>
                            <div class="assets-distribution" id="assetsDistribution">
                                <div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет открытых позиций</div>
                            </div>
                        </div>

                        <div class="portfolio-section">
                            <h3>🔥 Лучшая сделка дня</h3>
                            <div class="best-trade" id="bestTradeCard">
                                <div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет сделок сегодня</div>
                            </div>
                        </div>

                        <div class="portfolio-section">
                            <h3>📋 Последние движения</h3>
                            <div class="recent-moves" id="recentMoves">
                                <div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет активности</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Раздел 2: Терминал -->
                <div id="terminal-section" class="section-container">
                    <div class="terminal-section">
                        <div class="chart-container">
                            <div class="asset-selector">
                                <button class="asset-btn active" onclick="switchAsset('BTC/USD')">BTC/USD</button>
                                <button class="asset-btn" onclick="switchAsset('ETH/USD')">ETH/USD</button>
                                <button class="asset-btn" onclick="switchAsset('SOL/USD')">SOL/USD</button>
                                <button class="asset-btn" onclick="switchAsset('BNB/USD')">BNB/USD</button>
                            </div>
                            <div id="tv_widget"></div>
                        </div>
                        
                        <div class="trading-panel">
                            <div class="margin-info">
                                <div class="margin-row">
                                    <span class="margin-label">Баланс:</span>
                                    <span class="margin-value" id="virtualBalance">$10,000</span>
                                </div>
                                <div class="margin-row">
                                    <span class="margin-label">Использовано маржи:</span>
                                    <span class="margin-value used" id="usedMargin">$0</span>
                                </div>
                                <div class="margin-row">
                                    <span class="margin-label">Свободно:</span>
                                    <span class="margin-value free" id="freeMargin">$10,000</span>
                                </div>
                                <div class="margin-divider"></div>
                                <div class="margin-row">
                                    <span class="margin-label">Эквити:</span>
                                    <span class="margin-value" id="virtualEquity">$10,000</span>
                                </div>
                            </div>
                            
                            <div>
                                <div class="direction-selector">
                                    <button class="direction-btn long active" onclick="setDirection('long')" id="longDirBtn">LONG 📈</button>
                                    <button class="direction-btn short" onclick="setDirection('short')" id="shortDirBtn">SHORT 📉</button>
                                </div>
                                
                                <div class="trade-input-group">
                                    <label>Объем позиции (USD)</label>
                                    <input type="number" class="trade-input" id="tradeSize" value="100" min="10" max="10000" step="10" oninput="calculatePosition()">
                                </div>
                                
                                <div class="trade-input-group">
                                    <label>Кредитное плечо</label>
                                    <div class="leverage-buttons">
                                        <button class="leverage-btn active" onclick="setLeverage(1)">1x</button>
                                        <button class="leverage-btn" onclick="setLeverage(2)">2x</button>
                                        <button class="leverage-btn" onclick="setLeverage(5)">5x</button>
                                        <button class="leverage-btn" onclick="setLeverage(10)">10x</button>
                                        <button class="leverage-btn" onclick="setLeverage(20)">20x</button>
                                    </div>
                                </div>
                                
                                <div class="trade-input-group">
                                    <label>Стоп-лосс</label>
                                    <input type="number" class="trade-input" id="stopLoss" placeholder="Цена стопа" oninput="calculatePosition()">
                                </div>
                                
                                <div class="trade-input-group">
                                    <label>Тейк-профит</label>
                                    <input type="number" class="trade-input" id="takeProfit" placeholder="Цена тейка" oninput="calculatePosition()">
                                </div>
                                
                                <div class="calculate-info">
                                    <div class="calc-row">
                                        <span class="calc-label">Текущая цена:</span>
                                        <span class="calc-value" id="currentPrice">$0</span>
                                    </div>
                                    <div class="calc-row">
                                        <span class="calc-label">Маржа (требуется):</span>
                                        <span class="calc-value" id="marginRequired">$0</span>
                                    </div>
                                    <div class="calc-row">
                                        <span class="calc-label">Размер позиции:</span>
                                        <span class="calc-value" id="positionSize">$0</span>
                                    </div>
                                    <div class="calc-row">
                                        <span class="calc-label">Потенц. убыток:</span>
                                        <span class="calc-value loss" id="potentialLoss">$0</span>
                                    </div>
                                    <div class="calc-row">
                                        <span class="calc-label">Потенц. прибыль:</span>
                                        <span class="calc-value profit" id="potentialProfit">$0</span>
                                    </div>
                                </div>
                                
                                <button class="open-trade-btn" onclick="openTrade()">
                                    Открыть сделку
                                </button>
                            </div>
                            
                            <div>
                                <div class="positions-header">
                                    <span class="positions-title">Открытые позиции</span>
                                    <span id="positionsCount">0</span>
                                </div>
                                <div id="openPositions">
                                    <div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет открытых позиций</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Раздел 3: Тренажер -->
                <div id="trainer-section" class="section-container">
                    <div class="trainer-new-container">
                        <div class="trainer-header">
                            <div class="trainer-title">
                                <h2 id="trainerSessionTitle">Анализ графика</h2>
                                <p id="trainerSessionInfo">Загрузка...</p>
                            </div>
                            <div class="trainer-stats">
                                <span id="trainerSymbol">-</span>
                                <span id="trainerTimeframe">-</span>
                            </div>
                        </div>

                        <div class="chart-wrapper">
                            <canvas id="trainerCanvas" width="800" height="400"></canvas>
                        </div>

                        <div class="slider-container">
                            <span class="slider-label" id="currentCandle">0</span>
                            <input type="range" id="candleSlider" min="0" max="100" value="0" step="1">
                            <span class="slider-label" id="totalCandles">0</span>
                        </div>

                        <div class="animation-controls">
                            <button class="anim-btn" onclick="rewindStart()">⏮️</button>
                            <button class="anim-btn" onclick="playPause()" id="playPauseBtn">▶️</button>
                            <button class="anim-btn" onclick="stepBack()">◀</button>
                            <button class="anim-btn" onclick="stepForward()">▶</button>
                            <button class="anim-btn" onclick="rewindEnd()">⏭️</button>
                        </div>

                        <div class="task-info">
                            <span>📊 Куда пойдет цена после этого участка?</span>
                            <span class="task-badge" id="trainerPattern">Паттерн</span>
                        </div>

                        <div id="trainerResult"></div>

                        <div class="answer-buttons-new">
                            <button class="answer-btn-new long" onclick="checkTrainerAnswer('long')">📈 LONG</button>
                            <button class="answer-btn-new short" onclick="checkTrainerAnswer('short')">📉 SHORT</button>
                        </div>

                        <button class="next-btn-new" onclick="loadNextTraining()">
                            → Следующий график
                        </button>
                    </div>
                </div>

                <!-- Раздел 4: Обучение -->
                <div id="learning-section" class="section-container">
                    <div class="learning-header">
                        <button class="back-button hidden" id="learningBackBtn" onclick="showCoursesList()">
                            ← Назад к курсам
                        </button>
                    </div>

                    <div id="learningContent">
                        <div class="loading-state">
                            <div>📚</div>
                            <div>Загрузка курсов...</div>
                        </div>
                    </div>
                </div>

                <!-- Раздел 5: Дружеский забег -->
                <div id="friends-section" class="section-container">
                    <div class="friends-header">
                        <h2>Дружеский забег</h2>
                        <p style="color: var(--text-secondary);">Соревнуйтесь с друзьями и зарабатывайте XP</p>
                        <button class="invite-btn" onclick="inviteFriend()">+ Пригласить друга</button>
                    </div>

                    <div class="friends-tabs">
                        <div class="friends-tab active" onclick="switchFriendsTab('friends')">Мои друзья</div>
                        <div class="friends-tab" onclick="switchFriendsTab('requests')">Заявки</div>
                        <div class="friends-tab" onclick="switchFriendsTab('search')">Поиск</div>
                        <div class="friends-tab" onclick="switchFriendsTab('race')">Забег</div>
                    </div>

                    <div id="friendsContent">
                        <!-- Контент будет загружаться динамически -->
                        <div class="empty-state">
                            <div class="icon">👥</div>
                            <p>Загрузка...</p>
                        </div>
                    </div>
                </div>

                <!-- Раздел 6: Профиль -->
                <div id="profile-section" class="section-container">
                    <div class="profile-grid">
                        <!-- Левая колонка -->
                        <div class="profile-card">
                            <div class="avatar-upload">
                                <div class="profile-avatar-large" id="profileAvatar" onclick="document.getElementById('avatarInput').click()">
                                    <span id="profileAvatarText">A</span>
                                </div>
                                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar()">
                                <button class="avatar-upload-btn" onclick="document.getElementById('avatarInput').click()">
                                    📸 Изменить фото
                                </button>
                            </div>
                            
                            <h2 class="profile-name" id="profileFullName">Загрузка...</h2>
                            <div class="profile-username" id="profileUsername">@загрузка</div>
                            <div class="profile-rank" id="profileRank">Новичок</div>
                            
                            <div class="profile-invite">
                                <span class="invite-label">Код приглашения</span>
                                <div class="invite-code" onclick="copyInviteCode()">
                                    <span id="inviteCode">******</span>
                                    <span class="copy-icon">📋</span>
                                </div>
                            </div>
                            
                            <div class="profile-level-info">
                                <span class="level-badge" id="profileLevelBadge">Уровень 1</span>
                                <span class="xp-info" id="profileXpInfo">0/1000 XP</span>
                            </div>
                            
                            <div class="profile-bio">
                                <textarea id="profileBio" placeholder="Расскажите о себе..." rows="3" onchange="updateBio()">Загрузка...</textarea>
                            </div>
                            
                            <div class="profile-actions">
                                <button class="edit-profile-btn" onclick="editProfile()">✏️ Редактировать</button>
                                <button class="logout-btn" onclick="logout()">🚪 Выйти</button>
                            </div>
                        </div>

                        <!-- Правая колонка -->
                        <div class="progress-details">
                            <h3 style="margin-bottom: 1.5rem;">Статистика</h3>
                            
                            <div class="profile-stats" id="profileStats">
                                <div class="profile-stat">
                                    <div class="value" id="profileTrainings">0</div>
                                    <div class="label">тренировки</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="value" id="profileAccuracy">0%</div>
                                    <div class="label">точность</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="value" id="profileStreak">0</div>
                                    <div class="label">дней подряд</div>
                                </div>
                                <div class="profile-stat">
                                    <div class="value" id="profileAchievementsCount">0</div>
                                    <div class="label">достижения</div>
                                </div>
                            </div>

                            <!-- Только полученные достижения -->
                            <div class="achievements-section">
                                <h3>🏆 Полученные достижения</h3>
                                <div id="profileAchievementsGrid" class="achievements-grid">
                                    <div class="loading-state">Загрузка...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Правая панель -->
            <div class="right-panel">
                <div>
                    <div class="activity-header">
                        <h3>Активность</h3>
                        <span style="color: var(--accent-1);">Сегодня</span>
                    </div>
                    <div class="activity-list" id="activityList">
                        <div class="activity-item">Загрузка...</div>
                    </div>
                </div>

                <div class="streak-card" onclick="openAchievementsModal()">
                    <div class="streak-icon">🔥</div>
                    <div class="streak-days" id="streakDays">0</div>
                    <div style="color: var(--text-tertiary);">дней подряд</div>
                    <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--accent-2);">🏆 43 достижения</div>
                </div>

                <div>
                    <div class="activity-header">
                        <h3>Друзья онлайн</h3>
                        <span id="onlineFriends">0</span>
                    </div>
                    <div class="friends-online" id="friendsOnlineList">
                        <div style="color: var(--text-tertiary);">Нет друзей онлайн</div>
                    </div>
                </div>

                <div class="ticker" id="marketTicker">
                    <div class="ticker-item">Загрузка...</div>
                </div>

                <div class="tip-card" id="dailyTip">
                    <div class="tip-title">💡 Совет дня</div>
                    <div class="tip-content" id="tipContent">Загрузка...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка настроек -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Настройки</h3>
                <button class="close-btn" onclick="closeSettings()">×</button>
            </div>
            
            <div class="settings-group">
                <label>Тема</label>
                <div class="theme-toggle">
                    <div class="theme-option active" onclick="setTheme('dark')">Темная</div>
                    <div class="theme-option" onclick="setTheme('light')">Светлая</div>
                </div>
            </div>
            
            <div class="settings-group">
                <label>Язык</label>
                <select class="language-select" onchange="setLanguage(this.value)">
                    <option value="ru">Русский</option>
                    <option value="en">English</option>
                </select>
            </div>

            <div class="settings-group">
                <label>Уведомления</label>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="emailNotifications" checked> Email-рассылка
                    </label>
                    <label class="checkbox-label">
                        <input type="checkbox" id="pushNotifications" checked> Push-уведомления
                    </label>
                </div>
            </div>
        </div>
    </div>

    <!-- Модалка всех достижений -->
    <div class="modal" id="achievementsModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>🏆 Все достижения</h3>
                <button class="close-btn" onclick="closeAchievementsModal()">×</button>
            </div>
            
            <div id="achievementsContainer">
                <div class="loading-state">
                    <div>🏆</div>
                    <div>Загрузка достижений...</div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ============================================
        // ИНИЦИАЛИЗАЦИЯ SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://nfagdmgfkatrxkjrlofp.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mYWdkbWdma2F0cnhranJsb2ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTI2NTAsImV4cCI6MjA4NzAyODY1MH0._C3fe8XJVovmnJM7ZduaYSmUz8D0TWw6KO4y2D8jnYc'
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
        
        // ============================================
        // ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
        // ============================================
        let currentUser = null
        let currentTheme = 'dark'
        let currentSection = 'dashboard'
        let currentChart = null
        
        // Демо-терминал
        let virtualBalance = 10000
        let currentDirection = 'long'
        let currentLeverage = 1
        let currentPrice = 66000
        let currentAsset = 'BTC/USD'
        let openPositions = []
        let closedTrades = []
        let priceUpdateInterval = null
        let tradingViewWidget = null
        
        // Данные для разных активов
        const assetData = {
            'BTC/USD': { price: 66000, min: 50000, max: 80000 },
            'ETH/USD': { price: 3500, min: 2500, max: 4500 },
            'SOL/USD': { price: 80, min: 50, max: 120 },
            'BNB/USD': { price: 610, min: 500, max: 700 }
        }
        
        // Текущие цены для синхронизации
        let currentPrices = {
            'BTC/USD': 66000,
            'ETH/USD': 3500,
            'SOL/USD': 80,
            'BNB/USD': 610
        }
        
        // Переменные для обучения
        let currentCourse = null
        let currentLesson = null
        let completedLessons = new Set() // для быстрой проверки
        
        // Достижения
        let allAchievements = []
        let userAchievements = []
        
        // Друзья
        let friends = []
        let friendRequests = []
        let currentFriendsTab = 'friends'  // текущая вкладка в разделе друзей
        
        // ============================================
        // ФУНКЦИИ ДЛЯ УВЕДОМЛЕНИЙ
        // ============================================
        function showNotification(title, message, type = 'success', icon = null) {
            const container = document.getElementById('notificationContainer')
            if (!container) return
            
            const notification = document.createElement('div')
            notification.className = `notification ${type}`
            
            let iconHtml = ''
            if (icon) {
                iconHtml = `<div class="notification-icon">${icon}</div>`
            } else {
                const defaultIcons = {
                    success: '✅',
                    warning: '⚠️',
                    achievement: '🏆'
                }
                iconHtml = `<div class="notification-icon">${defaultIcons[type] || '📢'}</div>`
            }
            
            notification.innerHTML = `
                ${iconHtml}
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
            `
            
            container.appendChild(notification)
            
            setTimeout(() => {
                notification.style.animation = 'notificationSlideOut 0.3s ease'
                setTimeout(() => notification.remove(), 300)
            }, 5000)
        }

        // ============================================
        // ФОРМАТ ДАТЫ
        // ============================================
        function formatDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }
            return new Date().toLocaleDateString('ru-RU', options).toUpperCase()
        }
        
        // ============================================
        // ЗАГРУЗКА СТРАНИЦЫ
        // ============================================
        window.addEventListener('load', async function() {
            console.log('Страница загружена')
            document.getElementById('currentDate').textContent = formatDate()
            
            loadDailyTip()
            
            try {
                const { data: { session } } = await supabaseClient.auth.getSession()
                console.log('Сессия:', session ? 'есть' : 'нет')
                
                if (session) {
                    currentUser = session.user
                    console.log('Пользователь:', currentUser.email)
                    
                    setTimeout(() => {
                        document.getElementById('splash').classList.add('hidden')
                        document.getElementById('mainInterface').classList.add('active')
                        
                        loadUserProfile()
                        loadOpenPositions()
                        loadDashboardData()
                        loadAchievements()
                        loadFriends()
                    }, 500)
                } else {
                    setTimeout(() => {
                        document.getElementById('splash').classList.add('hidden')
                        document.getElementById('auth').classList.add('active')
                    }, 2000)
                }
            } catch (error) {
                console.error('Ошибка проверки сессии:', error)
                setTimeout(() => {
                    document.getElementById('splash').classList.add('hidden')
                    document.getElementById('auth').classList.add('active')
                }, 2000)
            }
        })
        
        // ============================================
        // КЛАСС АНИМАТОРА ДЛЯ ТРЕНАЖЕРА
        // ============================================
        class ChartAnimator {
            constructor(canvasId, data) {
                this.canvas = document.getElementById(canvasId)
                this.ctx = this.canvas.getContext('2d')
                this.data = data
                this.currentIndex = 0
                this.width = this.canvas.width
                this.height = this.canvas.height
                this.normalizeData()
            }
            
            normalizeData() {
                let minPrice = Infinity
                let maxPrice = -Infinity
                
                this.data.forEach(c => {
                    minPrice = Math.min(minPrice, parseFloat(c.low), parseFloat(c.high))
                    maxPrice = Math.max(maxPrice, parseFloat(c.low), parseFloat(c.high))
                })
                
                const padding = (maxPrice - minPrice) * 0.1
                this.minPrice = minPrice - padding
                this.maxPrice = maxPrice + padding
                this.priceRange = this.maxPrice - this.minPrice
            }
            
            priceToY(price) {
                return this.height - ((parseFloat(price) - this.minPrice) / this.priceRange) * this.height
            }
            
            drawCandles(start, end) {
                this.ctx.clearRect(0, 0, this.width, this.height)
                
                const isLightTheme = document.body.classList.contains('light-theme')
                const gridColor = isLightTheme ? '#DCE1EC' : '#2A2F3A'
                
                this.ctx.strokeStyle = gridColor
                this.ctx.lineWidth = 1
                
                for (let i = 0; i < 5; i++) {
                    let y = i * this.height / 4
                    this.ctx.beginPath()
                    this.ctx.moveTo(0, y)
                    this.ctx.lineTo(this.width, y)
                    this.ctx.strokeStyle = gridColor
                    this.ctx.stroke()
                }
                
                const candleWidth = 20
                const spacing = 5
                const startX = 50
                const totalCandles = end - start
                
                for (let i = 0; i < totalCandles; i++) {
                    let x = startX + i * (candleWidth + spacing)
                    
                    this.ctx.beginPath()
                    this.ctx.moveTo(x + candleWidth/2, 0)
                    this.ctx.lineTo(x + candleWidth/2, this.height)
                    this.ctx.strokeStyle = isLightTheme ? '#E8ECF5' : '#1E222A'
                    this.ctx.stroke()
                }
                
                for (let i = start; i < end; i++) {
                    if (i >= this.data.length) break
                    
                    const candle = this.data[i]
                    const x = startX + (i - start) * (candleWidth + spacing)
                    const isBullish = parseFloat(candle.close) > parseFloat(candle.open)
                    
                    if (isBullish) {
                        const gradient = this.ctx.createLinearGradient(x, 0, x + candleWidth, 0)
                        gradient.addColorStop(0, '#2ecc71')
                        gradient.addColorStop(1, '#27ae60')
                        this.ctx.fillStyle = gradient
                    } else {
                        const gradient = this.ctx.createLinearGradient(x, 0, x + candleWidth, 0)
                        gradient.addColorStop(0, '#e74c3c')
                        gradient.addColorStop(1, '#c0392b')
                        this.ctx.fillStyle = gradient
                    }
                    
                    const openY = this.priceToY(candle.open)
                    const closeY = this.priceToY(candle.close)
                    const bodyTop = Math.min(openY, closeY)
                    const bodyHeight = Math.abs(openY - closeY)
                    
                    if (bodyHeight > 0) {
                        this.ctx.fillRect(x, bodyTop, candleWidth, Math.max(2, bodyHeight))
                    } else {
                        this.ctx.fillRect(x, bodyTop - 1, candleWidth, 2)
                    }
                    
                    if (isLightTheme) {
                        this.ctx.strokeStyle = '#2C3E50'
                    } else {
                        this.ctx.strokeStyle = '#ECF0F1'
                    }
                    
                    this.ctx.lineWidth = 2
                    this.ctx.beginPath()
                    
                    const highY = this.priceToY(candle.high)
                    const lowY = this.priceToY(candle.low)
                    const centerX = x + candleWidth / 2
                    
                    if (highY < bodyTop) {
                        this.ctx.moveTo(centerX, highY)
                        this.ctx.lineTo(centerX, bodyTop)
                    }
                    
                    if (lowY > bodyTop + bodyHeight) {
                        this.ctx.moveTo(centerX, bodyTop + bodyHeight)
                        this.ctx.lineTo(centerX, lowY)
                    }
                    
                    this.ctx.stroke()
                }
                
                document.getElementById('currentCandle').textContent = end
                document.getElementById('candleSlider').value = end
                document.getElementById('totalCandles').textContent = this.data.length
            }
            
            setIndex(index) {
                this.currentIndex = Math.min(index, this.data.length)
                this.drawCandles(0, this.currentIndex)
            }
            
            play() {
                if (this.currentIndex >= this.data.length) return
                
                isPlaying = true
                document.getElementById('playPauseBtn').textContent = '⏸️'
                
                playInterval = setInterval(() => {
                    if (this.currentIndex < this.data.length) {
                        this.setIndex(this.currentIndex + 1)
                    } else {
                        this.pause()
                    }
                }, 300)
            }
            
            pause() {
                isPlaying = false
                document.getElementById('playPauseBtn').textContent = '▶️'
                if (playInterval) clearInterval(playInterval)
            }
            
            stepForward() {
                this.pause()
                if (this.currentIndex < this.data.length) {
                    this.setIndex(this.currentIndex + 1)
                }
            }
            
            stepBack() {
                this.pause()
                if (this.currentIndex > 0) {
                    this.setIndex(this.currentIndex - 1)
                }
            }
            
            rewindStart() {
                this.pause()
                this.setIndex(0)
            }
            
            rewindEnd() {
                this.pause()
                this.setIndex(this.data.length)
            }
        }

        // ============================================
        // ПЕРЕМЕННЫЕ ДЛЯ ТРЕНАЖЕРА
        // ============================================
        let trainerAnimator = null
        let currentTrainingSession = null
        let isPlaying = false
        let playInterval = null
        let trainerAnswered = false
        let trainerCorrectAnswer = null

        // ============================================
        // ЗАГРУЗКА СЛЕДУЮЩЕЙ ТРЕНИРОВКИ
        // ============================================
        async function loadNextTraining() {
            try {
                document.getElementById('trainerResult').innerHTML = ''
                trainerAnswered = false
                
                const { data, error } = await supabaseClient
                    .from('training_sessions')
                    .select('*')
                    .in('correct_direction', ['long', 'short'])
                    .limit(50)
                
                if (error) throw error
                
                if (!data || data.length === 0) {
                    document.getElementById('trainerSessionInfo').textContent = 'Нет данных с ответами'
                    return
                }
                
                const randomIndex = Math.floor(Math.random() * data.length)
                currentTrainingSession = data[randomIndex]
                trainerCorrectAnswer = currentTrainingSession.correct_direction
                
                console.log('🎯 Загружен график с ответом:', trainerCorrectAnswer)
                
                const candles = typeof currentTrainingSession.candles === 'string' 
                    ? JSON.parse(currentTrainingSession.candles) 
                    : currentTrainingSession.candles
                
                document.getElementById('trainerSessionInfo').textContent = 
                    `${currentTrainingSession.symbol} · ${currentTrainingSession.timeframe}`
                document.getElementById('trainerSymbol').textContent = currentTrainingSession.symbol
                document.getElementById('trainerTimeframe').textContent = currentTrainingSession.timeframe
                
                const patternName = currentTrainingSession.pattern?.type || 'mixed'
                document.getElementById('trainerPattern').textContent = patternName.replace(/_/g, ' ')
                
                if (trainerAnimator) trainerAnimator.pause()
                trainerAnimator = new ChartAnimator('trainerCanvas', candles)
                trainerAnimator.setIndex(0)
                
                const slider = document.getElementById('candleSlider')
                slider.max = candles.length
                slider.value = 0
                
            } catch (error) {
                console.error('Ошибка загрузки тренировки:', error)
                document.getElementById('trainerSessionInfo').textContent = 'Ошибка загрузки'
            }
        }

        // ============================================
        // ПРОВЕРКА ОТВЕТА В ТРЕНАЖЕРЕ
        // ============================================
        function checkTrainerAnswer(answer) {
            if (!currentTrainingSession) {
                alert('Сначала загрузите график')
                return
            }
            
            if (trainerAnswered) {
                alert('Вы уже ответили на этот график')
                return
            }
            
            trainerAnimator.pause()
            trainerAnimator.rewindEnd()
            
            let isCorrect = false
            const correctAnswer = trainerCorrectAnswer?.toLowerCase() || ''
            
            if (correctAnswer === 'long' || correctAnswer === 'short') {
                isCorrect = answer === correctAnswer
            } else {
                isCorrect = false
                console.log('⚠️ В БД нет правильного ответа для этого графика:', trainerCorrectAnswer)
            }
            
            trainerAnswered = true
            
            if (isCorrect && currentUser) {
                const xpEarned = 25
                updateUserStats(currentUser.id, true, xpEarned)
                loadUserProfile()
            }
            
            const resultDiv = document.getElementById('trainerResult')
            
            if (isCorrect) {
                resultDiv.innerHTML = '<div class="result-message correct">✅ Правильно! +25 XP</div>'
                showNotification('Правильно!', '+25 XP', 'success')
            } else {
                let message = ''
                if (correctAnswer === 'long' || correctAnswer === 'short') {
                    message = `❌ Неправильно. Правильный ответ: ${correctAnswer === 'long' ? 'LONG 📈' : 'SHORT 📉'}`
                } else {
                    message = '❌ Для этого графика нет однозначного ответа'
                }
                resultDiv.innerHTML = `<div class="result-message wrong">${message}</div>`
                showNotification('Неправильно', 'Попробуйте еще раз', 'warning')
            }
        }

        // ============================================
        // УПРАВЛЕНИЕ ТРЕНАЖЕРОМ
        // ============================================
        function playPause() {
            if (!trainerAnimator) return
            if (isPlaying) {
                trainerAnimator.pause()
            } else {
                trainerAnimator.play()
            }
        }

        function stepForward() {
            if (trainerAnimator) trainerAnimator.stepForward()
        }

        function stepBack() {
            if (trainerAnimator) trainerAnimator.stepBack()
        }

        function rewindStart() {
            if (trainerAnimator) trainerAnimator.rewindStart()
        }

        function rewindEnd() {
            if (trainerAnimator) trainerAnimator.rewindEnd()
        }

        // ============================================
        // ПОЛУЧЕНИЕ ТЕКУЩЕЙ ЦЕНЫ АКТИВА
        // ============================================
        async function getCurrentPrice(asset) {
            console.log(`💰 Получаем цену для ${asset}...`)
            
            if (currentPrices[asset] && currentPrices[asset] > 0) {
                return currentPrices[asset]
            }
            
            try {
                const symbols = {
                    'BTC/USD': 'BTCUSDT',
                    'ETH/USD': 'ETHUSDT',
                    'SOL/USD': 'SOLUSDT',
                    'BNB/USD': 'BNBUSDT'
                }
                
                const symbol = symbols[asset] || asset.replace('/', '')
                const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`)
                
                if (response.ok) {
                    const data = await response.json()
                    const price = parseFloat(data.price)
                    if (price && price > 0) {
                        currentPrices[asset] = price
                        return price
                    }
                }
            } catch (error) {
                console.error(`❌ Ошибка получения цены с Binance:`, error)
            }
            
            if (assetData[asset]) {
                return assetData[asset].price
            }
            
            return 0
        }

        // ============================================
        // ПОЛУЧЕНИЕ ЦЕНЫ С БИРЖИ (улучшенная версия)
        // ============================================
        async function fetchPriceWithRetry(asset, retries = 3) {
            const symbols = {
                'BTC/USD': 'BTCUSDT',
                'ETH/USD': 'ETHUSDT',
                'SOL/USD': 'SOLUSDT',
                'BNB/USD': 'BNBUSDT'
            }
            
            const symbol = symbols[asset]
            if (!symbol) return null
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`)
                    if (response.ok) {
                        const data = await response.json()
                        const price = parseFloat(data.price)
                        if (price && price > 0) {
                            return price
                        }
                    }
                } catch (error) {
                    console.log(`⚠️ Попытка ${i + 1} не удалась для ${asset}:`, error.message)
                }
                
                if (i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, 500))
                }
            }
            
            return null
        }

        // ============================================
        // МОНИТОРИНГ ЦЕН
        // ============================================
        function startPriceMonitoring() {
            console.log('▶️ ЗАПУСК МОНИТОРИНГА ЦЕН')
            
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval)
                priceUpdateInterval = null
            }
            
            async function updateAllPrices() {
                for (const asset of Object.keys(assetData)) {
                    try {
                        const symbols = {
                            'BTC/USD': 'BTCUSDT',
                            'ETH/USD': 'ETHUSDT',
                            'SOL/USD': 'SOLUSDT',
                            'BNB/USD': 'BNBUSDT'
                        }
                        
                        const symbol = symbols[asset]
                        const response = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`)
                        
                        if (response.ok) {
                            const data = await response.json()
                            const price = parseFloat(data.price)
                            if (price && price > 0) {
                                currentPrices[asset] = price
                            }
                        }
                    } catch (error) {
                        console.log(`❌ Ошибка получения цены ${asset}:`, error)
                    }
                }
                
                if (currentPrices[currentAsset]) {
                    currentPrice = currentPrices[currentAsset]
                    const priceElement = document.getElementById('currentPrice')
                    if (priceElement) priceElement.textContent = '$' + currentPrice.toFixed(2)
                }
                
                calculateAllPositionsPNL()
                updatePositionsDisplay()
                updateBalance()
                updatePortfolio()
            }
            
            updateAllPrices()
            priceUpdateInterval = setInterval(updateAllPrices, 2000)
        }

        // ============================================
        // ЗАГРУЗКА ПРОФИЛЯ ПОЛЬЗОВАТЕЛЯ
        // ============================================
        async function loadUserProfile() {
            if (!currentUser) return
            
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single()
                
                if (error) {
                    console.error('❌ Ошибка загрузки профиля:', error)
                    return
                }
                
                if (!profile) {
                    console.log('⚠️ Профиль не найден, создаем...')
                    const { error: insertError } = await supabaseClient
                        .from('profiles')
                        .insert([{ 
                            id: currentUser.id,
                            full_name: currentUser.email?.split('@')[0] || 'Трейдер',
                            virtual_balance: 10000,
                            xp: 0,
                            level: 1,
                            rank: 'Новичок',
                            trainings_count: 0,
                            correct_predictions: 0,
                            accuracy: 0
                        }])
                    
                    if (insertError) console.error('Ошибка создания профиля:', insertError)
                    return
                }
                
                console.log('📊 Данные профиля:', profile)
                
                virtualBalance = profile.virtual_balance || 10000
                
                const compactLevel = document.getElementById('compactLevel')
                const compactRank = document.getElementById('compactRank')
                const compactXp = document.getElementById('compactXp')
                const compactXpBar = document.getElementById('compactXpBar')
                const compactAvatar = document.getElementById('compactAvatar')
                
                if (compactLevel) compactLevel.textContent = `Уровень ${profile.level || 1}`
                if (compactRank) compactRank.textContent = profile.rank || 'Новичок'
                if (compactXp) compactXp.textContent = `${profile.xp || 0} XP`
                
                const currentXp = profile.xp || 0
                const nextLevelXp = (Math.floor(currentXp / 1000) + 1) * 1000
                const xpProgress = ((currentXp % 1000) / 10)
                
                if (compactXpBar) compactXpBar.style.width = `${xpProgress}%`
                if (document.getElementById('compactXpNext')) {
                    document.getElementById('compactXpNext').textContent = `→ ${nextLevelXp} XP`
                }
                
                if (compactAvatar) {
                    if (profile.avatar_url) {
                        compactAvatar.innerHTML = `<img src="${profile.avatar_url}" style="width:100%; height:100%; border-radius:16px; object-fit:cover;">`
                    } else {
                        compactAvatar.textContent = profile.full_name?.charAt(0) || 'U'
                    }
                }
                
                const userName = document.getElementById('userName')
                const dashboardRank = document.getElementById('dashboardRank')
                const profileFullName = document.getElementById('profileFullName')
                const profileRank = document.getElementById('profileRank')
                const profileLevelBadge = document.getElementById('profileLevelBadge')
                const profileXpInfo = document.getElementById('profileXpInfo')
                
                if (userName) userName.textContent = profile.full_name || 'Трейдер'
                if (dashboardRank) dashboardRank.textContent = profile.rank || 'Новичок'
                if (profileFullName) profileFullName.textContent = profile.full_name || 'Трейдер'
                if (profileRank) profileRank.textContent = profile.rank || 'Новичок'
                if (profileLevelBadge) profileLevelBadge.textContent = `Уровень ${profile.level || 1}`
                
                const xp = profile.xp || 0
                const nextLevel = (Math.floor(xp / 1000) + 1) * 1000
                if (profileXpInfo) profileXpInfo.textContent = `${xp}/${nextLevel} XP`
                
                const avatarElement = document.getElementById('profileAvatar')
                const avatarText = document.getElementById('profileAvatarText')
                
                if (avatarElement) {
                    if (profile.avatar_url) {
                        avatarElement.innerHTML = `<img src="${profile.avatar_url}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`
                        if (avatarText) avatarText.style.display = 'none'
                    } else {
                        if (avatarText) {
                            avatarText.textContent = profile.full_name?.charAt(0) || 'U'
                            avatarText.style.display = 'block'
                        }
                    }
                }
                
                const profileUsername = document.getElementById('profileUsername')
                if (profileUsername) {
                    if (profile.username) {
                        profileUsername.textContent = '@' + profile.username
                    } else {
                        const defaultUsername = 'user_' + Math.random().toString(36).substring(2, 8)
                        profileUsername.textContent = '@' + defaultUsername
                    }
                }
                
                const inviteCode = document.getElementById('inviteCode')
                if (inviteCode) inviteCode.textContent = profile.invite_code || '------'
                
                const bioTextarea = document.getElementById('profileBio')
                if (bioTextarea) bioTextarea.value = profile.bio || 'Расскажите о себе...'
                
                const elements = {
                    profileTrainings: document.getElementById('profileTrainings'),
                    profileAccuracy: document.getElementById('profileAccuracy'),
                    profileStreak: document.getElementById('profileStreak'),
                    metricTrainings: document.getElementById('metricTrainings'),
                    metricAccuracy: document.getElementById('metricAccuracy'),
                    streakDays: document.getElementById('streakDays'),
                    profileAchievementsCount: document.getElementById('profileAchievementsCount')
                }
                
                if (elements.profileTrainings) elements.profileTrainings.textContent = profile.trainings_count || 0
                if (elements.profileAccuracy) elements.profileAccuracy.textContent = (profile.accuracy || 0).toFixed(1) + '%'
                if (elements.profileStreak) elements.profileStreak.textContent = profile.streak_days || 0
                if (elements.metricTrainings) elements.metricTrainings.textContent = profile.trainings_count || 0
                if (elements.metricAccuracy) elements.metricAccuracy.textContent = (profile.accuracy || 0).toFixed(1) + '%'
                if (elements.streakDays) elements.streakDays.textContent = profile.streak_days || 0
                
                updatePortfolio()
                
                await loadUserProgress()
                await loadAchievements()
                
            } catch (error) {
                console.error('❌ Ошибка загрузки профиля:', error)
            }
        }
        
        // ============================================
        // ЗАГРУЗКА ОТКРЫТЫХ ПОЗИЦИЙ
        // ============================================
        async function loadOpenPositions() {
            if (!currentUser) return
            
            try {
                console.log('📥 Загружаем позиции для пользователя:', currentUser.id)
                
                const { data: trainings, error } = await supabaseClient
                    .from('trainings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'open')
                
                if (error) {
                    console.error('❌ Ошибка загрузки позиций:', error)
                    return
                }
                
                if (trainings && trainings.length > 0) {
                    openPositions = trainings.map(t => {
                        const margin = t.position_size / (t.leverage || 1)
                        
                        return {
                            id: t.id,
                            asset: t.pair,
                            direction: t.prediction,
                            size: parseFloat(t.position_size) || 0,
                            leverage: parseInt(t.leverage) || 1,
                            entryPrice: parseFloat(t.entry_price) || 0,
                            stopLoss: t.stop_loss ? parseFloat(t.stop_loss) : null,
                            takeProfit: t.take_profit ? parseFloat(t.take_profit) : null,
                            margin: margin,
                            timestamp: new Date(t.created_at),
                            currentPNL: 0
                        }
                    })
                    
                    updatePositionsDisplay()
                    updateBalance()
                } else {
                    openPositions = []
                }
                
                const { data: closed, error: closedError } = await supabaseClient
                    .from('trainings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .in('status', ['closed', 'stopped', 'profited'])
                    .order('created_at', { ascending: false })
                    .limit(20)
                
                if (closedError) {
                    console.error('❌ Ошибка загрузки истории:', closedError)
                    return
                }
                
                if (closed && closed.length > 0) {
                    closedTrades = closed.map(t => ({
                        id: t.id,
                        asset: t.pair,
                        direction: t.prediction,
                        size: parseFloat(t.position_size) || 0,
                        leverage: parseInt(t.leverage) || 1,
                        entryPrice: parseFloat(t.entry_price) || 0,
                        exitPrice: parseFloat(t.exit_price) || 0,
                        finalPNL: parseFloat(t.pnl) || 0,
                        closedAt: new Date(t.closed_at || t.created_at)
                    }))
                    
                    updateRecentMoves(closedTrades)
                    updateBestTrade(closedTrades)
                }
                
            } catch (error) {
                console.error('❌ Ошибка в loadOpenPositions:', error)
            }
        }
        
        // ============================================
        // ЗАГРУЗКА СОВЕТА ДНЯ
        // ============================================
        function loadDailyTip() {
            const tips = [
                "Объем подтверждает тренд - ищите рост объемов при пробое уровней",
                "Не рискуйте более 2% от депозита в одной сделке",
                "Тренд - ваш друг, торгуйте по направлению тренда",
                "Стоп-лосс должен быть на уровне, где ваша идея перестает быть верной",
                "Паттерн 'Голова и плечи' - один из самых надежных разворотных паттернов",
                "Дивергенция RSI часто предшествует развороту цены",
                "Чем старше таймфрейм, тем сильнее сигнал",
                "Не усредняйте убыточные позиции",
                "Ведите дневник сделок - это лучший способ учиться на ошибках",
                "Рынок может оставаться иррациональным дольше, чем вы можете оставаться платежеспособным"
            ]
            
            const randomTip = tips[Math.floor(Math.random() * tips.length)]
            const tipContent = document.getElementById('tipContent')
            if (tipContent) tipContent.textContent = randomTip
        }
        
        // ============================================
        // АВТОРИЗАЦИЯ
        // ============================================
        function switchAuthTab(tab) {
            const tabs = document.getElementById('authTabs')
            const loginForm = document.getElementById('loginForm')
            const registerForm = document.getElementById('registerForm')
            const tabButtons = document.querySelectorAll('.auth-tab')
            
            if (tab === 'login') {
                tabs.classList.remove('register-mode')
                tabs.classList.add('login-mode')
                loginForm.classList.remove('hidden')
                registerForm.classList.add('hidden')
                tabButtons[0].classList.add('active')
                tabButtons[1].classList.remove('active')
            } else {
                tabs.classList.remove('login-mode')
                tabs.classList.add('register-mode')
                registerForm.classList.remove('hidden')
                loginForm.classList.add('hidden')
                tabButtons[1].classList.add('active')
                tabButtons[0].classList.remove('active')
            }
        }
        
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value
            const password = document.getElementById('loginPassword').value
            const errorDiv = document.getElementById('loginError')
            
            if (!email || !password) {
                errorDiv.textContent = 'Заполните все поля'
                return
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email, password
                })
                
                if (error) throw error
                
                console.log('✅ Успешный вход:', data.user.email)
                
                currentUser = data.user
                document.getElementById('auth').classList.remove('active')
                document.getElementById('mainInterface').classList.add('active')
                
                await loadUserProfile()
                await loadOpenPositions()
                await loadDashboardData()
                await loadAchievements()
                await loadFriends()
                
                showNotification('Добро пожаловать!', `Привет, ${data.user.email}`, 'success')
                
            } catch (error) {
                console.error('❌ Ошибка входа:', error)
                errorDiv.textContent = error.message
            }
        }
        
        async function handleRegister() {
            const name = document.getElementById('registerName').value
            const email = document.getElementById('registerEmail').value
            const password = document.getElementById('registerPassword').value
            const level = document.getElementById('registerLevel').value
            const errorDiv = document.getElementById('registerError')
            
            if (!name || !email || !password) {
                errorDiv.textContent = 'Заполните все поля'
                return
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email, password,
                    options: {
                        data: {
                            full_name: name,
                            experience: level
                        }
                    }
                })
                
                if (error) throw error
                
                const username = email.split('@')[0].toLowerCase().replace(/[^a-z0-9]/g, '') + 
                                Math.random().toString(36).substring(2, 5)
                
                await supabaseClient
                    .from('profiles')
                    .update({ 
                        username: username,
                        full_name: name,
                        rank: 'Новичок'
                    })
                    .eq('id', data.user.id)
                
                alert('Регистрация успешна! Проверьте почту для подтверждения.')
                switchAuthTab('login')
                
            } catch (error) {
                errorDiv.textContent = error.message
            }
        }
        
        // ============================================
        // ТЕРМИНАЛ
        // ============================================
        
        function getSymbol(asset) {
            const symbols = {
                'BTC/USD': 'BINANCE:BTCUSDT',
                'ETH/USD': 'BINANCE:ETHUSDT',
                'SOL/USD': 'BINANCE:SOLUSDT',
                'BNB/USD': 'BINANCE:BNBUSDT'
            }
            return symbols[asset] || 'BINANCE:BTCUSDT'
        }
        
        function initTerminal() {
            console.log('🟢 ИНИЦИАЛИЗАЦИЯ ТЕРМИНАЛА для', currentAsset)
            
            const container = document.getElementById('tv_widget')
            if (!container) return
            
            container.innerHTML = ''
            
            const widgetId = 'tradingview_' + Date.now()
            const widgetContainer = document.createElement('div')
            widgetContainer.id = widgetId
            widgetContainer.style.width = '100%'
            widgetContainer.style.height = '100%'
            container.appendChild(widgetContainer)
            
            function createWidget() {
                try {
                    console.log('📊 Создаем виджет для', currentAsset)
                    
                    tradingViewWidget = new TradingView.widget({
                        "container_id": widgetId,
                        "width": "100%",
                        "height": "100%",
                        "symbol": getSymbol(currentAsset),
                        "interval": "60",
                        "timezone": "Europe/Moscow",
                        "theme": currentTheme === 'dark' ? 'dark' : 'light',
                        "style": "1",
                        "locale": "ru",
                        "toolbar_bg": "#f1f3f6",
                        "enable_publishing": false,
                        "hide_top_toolbar": true,
                        "save_image": false,
                        "studies": [],
                        "show_popup_button": false,
                        "withdateranges": true,
                        "hide_side_toolbar": false
                    });

                    console.log('✅ График создан для', currentAsset);
                    startPriceMonitoring();
                    
                } catch (error) {
                    console.error('❌ Ошибка создания графика:', error);
                    startPriceMonitoring();
                }
            }
            
            if (typeof TradingView === 'undefined') {
                console.log('📥 Загружаем TradingView...')
                const script = document.createElement('script')
                script.src = 'https://s3.tradingview.com/tv.js'
                script.onload = () => {
                    setTimeout(createWidget, 500)
                }
                document.head.appendChild(script)
            } else {
                createWidget()
            }
        }
        
        async function fetchRealPrice(asset) {
            const symbols = {
                'BTC/USD': 'BTCUSDT',
                'ETH/USD': 'ETHUSDT',
                'SOL/USD': 'SOLUSDT',
                'BNB/USD': 'BNBUSDT'
            }
            
            const symbol = symbols[asset]
            if (!symbol) return null
            
            const apis = [
                `https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`,
                `https://api1.binance.com/api/v3/ticker/price?symbol=${symbol}`,
                `https://api2.binance.com/api/v3/ticker/price?symbol=${symbol}`,
                `https://api3.binance.com/api/v3/ticker/price?symbol=${symbol}`
            ]
            
            for (const api of apis) {
                try {
                    const response = await fetch(api)
                    if (response.ok) {
                        const data = await response.json()
                        const price = parseFloat(data.price)
                        if (price && price > 0) {
                            return price
                        }
                    }
                } catch (error) {
                    console.log(`Ошибка API ${api}, пробуем следующий...`)
                }
            }
            
            return null
        }
        
        function calculateUsedMargin() {
            let usedMargin = 0
            openPositions.forEach(pos => {
                usedMargin += pos.margin || 0
            })
            return usedMargin
        }
        
        // ============================================
        // БЕЗОПАСНЫЙ РАСЧЕТ P&L
        // ============================================
        function calculatePNL(position, currentPrice) {
            if (!position) return 0
            if (!currentPrice || currentPrice <= 0) return 0
            if (!position.entryPrice || position.entryPrice <= 0) return 0
            if (!position.size || position.size <= 0) return 0
            
            try {
                const positionSizeInUnits = position.size / position.entryPrice
                
                if (isNaN(positionSizeInUnits) || !isFinite(positionSizeInUnits)) {
                    return 0
                }
                
                const priceDiff = currentPrice - position.entryPrice
                
                let pnl
                if (position.direction === 'long') {
                    pnl = priceDiff * positionSizeInUnits
                } else {
                    pnl = -priceDiff * positionSizeInUnits
                }
                
                if (isNaN(pnl) || !isFinite(pnl)) {
                    return 0
                }
                
                return pnl
                
            } catch (error) {
                console.error('❌ Ошибка расчета P&L:', error)
                return 0
            }
        }

        // ============================================
        // ПЕРЕСЧЕТ P&L ДЛЯ ВСЕХ ПОЗИЦИЙ
        // ============================================
        function calculateAllPositionsPNL() {
            openPositions.forEach(position => {
                const assetPrice = currentPrices[position.asset] || currentPrice
                position.currentPNL = calculatePNL(position, assetPrice)
            })
        }

        // ============================================
        // ОТЛАДКА ДАННЫХ ПОЗИЦИИ
        // ============================================
        function debugPosition(positionId) {
            const position = openPositions.find(p => p.id === positionId)
            if (!position) {
                console.log('❌ Позиция не найдена')
                return
            }
            
            console.log('🔍 ОТЛАДКА ПОЗИЦИИ:', position)
        }
        
        async function openTrade() {
            const size = parseFloat(document.getElementById('tradeSize').value)
            const sl = parseFloat(document.getElementById('stopLoss').value)
            const tp = parseFloat(document.getElementById('takeProfit').value)
            
            if (sl && sl >= currentPrice && currentDirection === 'long') {
                alert('Стоп-лосс для LONG должен быть ниже текущей цены')
                return
            }
            if (sl && sl <= currentPrice && currentDirection === 'short') {
                alert('Стоп-лосс для SHORT должен быть выше текущей цены')
                return
            }
            if (tp && tp <= currentPrice && currentDirection === 'long') {
                alert('Тейк-профит для LONG должен быть выше текущей цены')
                return
            }
            if (tp && tp >= currentPrice && currentDirection === 'short') {
                alert('Тейк-профит для SHORT должен быть ниже текущей цены')
                return
            }
            
            const margin = size / currentLeverage
            
            if (margin > virtualBalance) {
                alert(`❌ Недостаточно средств. Нужно $${margin.toFixed(2)} маржи, доступно $${virtualBalance.toFixed(2)}`)
                return
            }
            
            const usedMargin = calculateUsedMargin()
            const availableBalance = virtualBalance - usedMargin
            
            if (margin > availableBalance) {
                alert(`❌ Недостаточно свободной маржи. Доступно: $${availableBalance.toFixed(2)}, нужно: $${margin.toFixed(2)}`)
                return
            }
            
            if (!currentUser) {
                alert('Сначала войдите в систему')
                return
            }
            
            try {
                const tradeData = {
                    user_id: currentUser.id,
                    pair: currentAsset,
                    prediction: currentDirection,
                    entry_price: currentPrice,
                    stop_loss: sl || null,
                    take_profit: tp || null,
                    position_size: size,
                    leverage: currentLeverage,
                    status: 'open'
                }
                
                const { data, error } = await supabaseClient
                    .from('trainings')
                    .insert([tradeData])
                    .select()
                
                if (error) {
                    console.error('❌ Ошибка от Supabase:', error)
                    alert('Ошибка при сохранении: ' + error.message)
                    return
                }
                
                if (!data || data.length === 0) {
                    alert('Ошибка: не получен ID сделки')
                    return
                }
                
                const newTrade = data[0]
                
                const position = {
                    id: newTrade.id,
                    asset: currentAsset,
                    direction: currentDirection,
                    size: size,
                    leverage: currentLeverage,
                    entryPrice: currentPrice,
                    stopLoss: sl || null,
                    takeProfit: tp || null,
                    margin: margin,
                    timestamp: new Date(),
                    currentPNL: 0
                }
                
                virtualBalance -= margin
                openPositions.push(position)
                
                updateBalance()
                updatePositionsDisplay()
                calculatePosition()
                updatePortfolio()
                
                showNotification('Сделка открыта', `${currentDirection === 'long' ? 'LONG' : 'SHORT'} ${currentAsset} на $${size}`, 'success')
                
            } catch (error) {
                console.error('❌ Критическая ошибка:', error)
                alert('Ошибка при открытии сделки: ' + error.message)
            }
        }
        
        // ============================================
        // ЗАКРЫТИЕ ПОЗИЦИИ
        // ============================================
        async function closePosition(positionId) {
            const position = openPositions.find(p => p.id === positionId)
            if (!position) {
                alert('Ошибка: позиция не найдена')
                return
            }
            
            if (!position.entryPrice || position.entryPrice <= 0) {
                try {
                    const { data } = await supabaseClient
                        .from('trainings')
                        .select('entry_price')
                        .eq('id', position.id)
                        .single()
                    
                    if (data && data.entry_price && data.entry_price > 0) {
                        position.entryPrice = data.entry_price
                    } else {
                        alert('Ошибка: не удалось получить цену входа')
                        return
                    }
                } catch (error) {
                    alert('Ошибка при получении данных сделки')
                    return
                }
            }
            
            if (!position.size || position.size <= 0) {
                try {
                    const { data } = await supabaseClient
                        .from('trainings')
                        .select('position_size')
                        .eq('id', position.id)
                        .single()
                    
                    if (data && data.position_size && data.position_size > 0) {
                        position.size = data.position_size
                    } else {
                        alert('Ошибка: размер позиции не может быть 0')
                        return
                    }
                } catch (error) {
                    alert('Ошибка при получении данных сделки')
                    return
                }
            }
            
            if (!position.margin || position.margin <= 0) {
                position.margin = position.size / (position.leverage || 1)
            }
            
            let assetPrice = currentPrices[position.asset]
            
            if (!assetPrice || assetPrice <= 0) {
                try {
                    assetPrice = await fetchPriceWithRetry(position.asset)
                    if (assetPrice && assetPrice > 0) {
                        currentPrices[position.asset] = assetPrice
                    }
                } catch (error) {
                    console.error('❌ Ошибка получения цены:', error)
                }
            }
            
            if (!assetPrice || assetPrice <= 0) {
                assetPrice = position.entryPrice
            }
            
            let finalPNL = 0
            try {
                const positionSizeInUnits = position.size / position.entryPrice
                const priceDiff = assetPrice - position.entryPrice
                
                if (position.direction === 'long') {
                    finalPNL = priceDiff * positionSizeInUnits
                } else {
                    finalPNL = -priceDiff * positionSizeInUnits
                }
                
                if (isNaN(finalPNL) || !isFinite(finalPNL)) {
                    finalPNL = 0
                }
            } catch (error) {
                console.error('❌ Ошибка расчета P&L:', error)
            }
            
            virtualBalance += position.margin + finalPNL
            
            try {
                const updateData = {
                    status: 'closed',
                    exit_price: assetPrice,
                    pnl: finalPNL,
                    is_correct: finalPNL > 0,
                    xp_earned: Math.max(1, Math.floor(Math.abs(finalPNL) / 10)),
                    closed_at: new Date().toISOString()
                }
                
                const { data, error } = await supabaseClient
                    .from('trainings')
                    .update(updateData)
                    .eq('id', position.id)
                    .select()
                
                if (error) {
                    console.error('❌ Ошибка обновления в БД:', error)
                    alert('Ошибка при обновлении сделки: ' + (error.message || 'Неизвестная ошибка'))
                    return
                }
                
                const closedTrade = {
                    id: position.id,
                    asset: position.asset,
                    direction: position.direction,
                    size: position.size,
                    leverage: position.leverage,
                    entryPrice: position.entryPrice,
                    exitPrice: assetPrice,
                    finalPNL: finalPNL,
                    closedAt: new Date()
                }
                
                closedTrades.unshift(closedTrade)
                openPositions = openPositions.filter(p => p.id !== positionId)
                
                updateBalance()
                updatePositionsDisplay()
                updatePortfolio()
                updateRecentMoves(closedTrades.slice(0, 5))
                updateBestTrade(closedTrades)
                
                await updateUserStats(currentUser.id, finalPNL > 0, Math.max(1, Math.floor(Math.abs(finalPNL) / 10)))
                await checkAchievements()
                
                const roi = position.margin > 0 ? ((finalPNL / position.margin) * 100).toFixed(1) : '0.0'
                
                if (finalPNL >= 0) {
                    showNotification('Сделка закрыта', `Прибыль: $${finalPNL.toFixed(2)} (ROI: ${roi}%)`, 'success')
                } else {
                    showNotification('Сделка закрыта', `Убыток: $${Math.abs(finalPNL).toFixed(2)} (ROI: ${roi}%)`, 'warning')
                }
                
            } catch (error) {
                console.error('❌ Ошибка закрытия сделки:', error)
                alert('Ошибка при закрытии сделки: ' + (error.message || 'Неизвестная ошибка'))
            }
        }
        
        function checkStopLossAndTakeProfit() {
            openPositions.forEach(position => {
                const assetPrice = currentPrices[position.asset] || currentPrice
                
                if (position.stopLoss) {
                    if (position.direction === 'long' && assetPrice <= position.stopLoss) {
                        closePosition(position.id)
                    }
                    if (position.direction === 'short' && assetPrice >= position.stopLoss) {
                        closePosition(position.id)
                    }
                }
                
                if (position.takeProfit) {
                    if (position.direction === 'long' && assetPrice >= position.takeProfit) {
                        closePosition(position.id)
                    }
                    if (position.direction === 'short' && assetPrice <= position.takeProfit) {
                        closePosition(position.id)
                    }
                }
            })
        }
        
        function updatePositionsDisplay() {
            const container = document.getElementById('openPositions')
            const countSpan = document.getElementById('positionsCount')
            
            if (openPositions.length === 0) {
                if (container) container.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет открытых позиций</div>'
                if (countSpan) countSpan.textContent = '0'
                return
            }
            
            if (countSpan) countSpan.textContent = openPositions.length
            
            if (!container) return
            
            container.innerHTML = openPositions.map(pos => {
                const assetPrice = currentPrices[pos.asset] || currentPrice
                const pnl = pos.currentPNL || 0
                const pnlClass = pnl >= 0 ? 'pnl-positive' : 'pnl-negative'
                const pnlText = (pnl >= 0 ? '+' : '') + pnl.toFixed(2)
                const pnlPercent = pos.margin > 0 ? ((pnl / pos.margin) * 100).toFixed(1) : '0.0'
                const entryPriceFormatted = pos.entryPrice.toFixed(2)
                const currentPriceFormatted = assetPrice.toFixed(2)
                
                return `
                    <div class="position-card">
                        <div class="position-header">
                            <span class="position-direction ${pos.direction}">${pos.direction === 'long' ? 'LONG 📈' : 'SHORT 📉'}</span>
                            <span class="position-asset">${pos.asset}</span>
                            <button class="position-close" onclick="closePosition(${pos.id})">✕</button>
                        </div>
                        <div class="position-details">
                            <span>Вход: $${entryPriceFormatted}</span>
                            <span>Текущая: $${currentPriceFormatted}</span>
                            <span>Объем: $${pos.size}</span>
                            <span>Плечо: ${pos.leverage}x</span>
                            <span>Маржа: $${pos.margin.toFixed(2)}</span>
                            ${pos.stopLoss ? `<span style="color: var(--accent-3);">SL: $${pos.stopLoss.toFixed(2)}</span>` : ''}
                            ${pos.takeProfit ? `<span style="color: var(--accent-4);">TP: $${pos.takeProfit.toFixed(2)}</span>` : ''}
                        </div>
                        <div class="position-pnl">
                            <span class="${pnlClass}">P&L: ${pnlText} USD (${pnlPercent}%)</span>
                        </div>
                    </div>
                `
            }).join('')
            
            checkStopLossAndTakeProfit()
        }
        
        function updateBalance() {
            const balanceEl = document.getElementById('virtualBalance')
            const metricBalanceEl = document.getElementById('metricBalance')
            const equityEl = document.getElementById('virtualEquity')
            const usedMarginEl = document.getElementById('usedMargin')
            const freeMarginEl = document.getElementById('freeMargin')
            
            if (balanceEl) balanceEl.textContent = '$' + virtualBalance.toFixed(2)
            if (metricBalanceEl) metricBalanceEl.textContent = '$' + virtualBalance.toFixed(0)
            
            const usedMargin = calculateUsedMargin()
            const freeMargin = virtualBalance - usedMargin
            
            if (usedMarginEl) usedMarginEl.textContent = '$' + usedMargin.toFixed(2)
            if (freeMarginEl) freeMarginEl.textContent = '$' + freeMargin.toFixed(2)
            
            let equity = virtualBalance
            openPositions.forEach(position => {
                equity += position.currentPNL || 0
            })
            if (equityEl) equityEl.textContent = 'Эквити: $' + equity.toFixed(2)
        }
        
        function updatePortfolio() {
            if (!currentUser) return
            
            let totalPNL = 0
            let totalMargin = 0
            let totalVolume = 0
            let assetExposure = {}
            
            openPositions.forEach(pos => {
                totalPNL += pos.currentPNL || 0
                totalMargin += pos.margin || 0
                totalVolume += pos.size || 0
                
                if (!assetExposure[pos.asset]) {
                    assetExposure[pos.asset] = {
                        volume: 0,
                        pnl: 0,
                        count: 0
                    }
                }
                assetExposure[pos.asset].volume += pos.size
                assetExposure[pos.asset].pnl += pos.currentPNL || 0
                assetExposure[pos.asset].count++
            })
            
            const equity = virtualBalance + totalPNL
            const changePercent = ((equity - 10000) / 10000 * 100).toFixed(2)
            
            const balanceEl = document.getElementById('portfolioBalance')
            const equityEl = document.getElementById('portfolioEquity')
            const changeEl = document.getElementById('portfolioChange')
            
            if (balanceEl) balanceEl.textContent = '$' + virtualBalance.toFixed(2)
            if (equityEl) equityEl.textContent = '$' + equity.toFixed(2)
            if (changeEl) {
                changeEl.textContent = (equity >= 10000 ? '+' : '') + changePercent + '%'
                changeEl.style.color = equity >= 10000 ? 'var(--accent-4)' : 'var(--accent-3)'
            }
            
            const tradesCountEl = document.getElementById('openTradesCount')
            const volumeEl = document.getElementById('totalVolume')
            const marginEl = document.getElementById('totalMargin')
            const pnlEl = document.getElementById('totalPNL')
            
            if (tradesCountEl) tradesCountEl.textContent = openPositions.length
            if (volumeEl) volumeEl.textContent = '$' + totalVolume.toFixed(2)
            if (marginEl) marginEl.textContent = '$' + totalMargin.toFixed(2)
            if (pnlEl) {
                pnlEl.textContent = (totalPNL >= 0 ? '+' : '') + totalPNL.toFixed(2)
                pnlEl.style.color = totalPNL >= 0 ? 'var(--accent-4)' : 'var(--accent-3)'
            }
            
            updateAssetsDistribution(assetExposure)
            
            const updateTimeEl = document.getElementById('portfolioUpdateTime')
            if (updateTimeEl) updateTimeEl.textContent = 'сейчас'
        }
        
        function updateAssetsDistribution(assetExposure) {
            const container = document.getElementById('assetsDistribution')
            if (!container) return
            
            if (Object.keys(assetExposure).length === 0) {
                container.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет открытых позиций</div>'
                return
            }
            
            const totalVolume = Object.values(assetExposure).reduce((sum, a) => sum + a.volume, 0)
            
            container.innerHTML = Object.entries(assetExposure).map(([asset, data]) => {
                const percent = ((data.volume / totalVolume) * 100).toFixed(1)
                const assetColor = asset === 'BTC/USD' ? '#F7931A' : 
                                  asset === 'ETH/USD' ? '#627EEA' :
                                  asset === 'SOL/USD' ? '#00FFA3' : '#F0B90B'
                
                return `
                    <div class="asset-row">
                        <div class="asset-icon" style="color: ${assetColor};">${asset.split('/')[0]}</div>
                        <div class="asset-info">
                            <div class="asset-name">${asset}</div>
                            <div class="asset-details">
                                <span>Объем: $${data.volume.toFixed(2)}</span>
                                <span style="color: ${data.pnl >= 0 ? 'var(--accent-4)' : 'var(--accent-3)'};">
                                    ${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(2)}
                                </span>
                            </div>
                            <div class="asset-progress">
                                <div class="asset-progress-fill" style="width: ${percent}%;"></div>
                            </div>
                        </div>
                    </div>
                `
            }).join('')
        }
        
        function updateRecentMoves(trades) {
            const container = document.getElementById('recentMoves')
            if (!container) return
            
            if (!trades || trades.length === 0) {
                container.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет активности</div>'
                return
            }
            
            container.innerHTML = trades.slice(0, 5).map(trade => {
                const asset = trade.asset || 'Unknown'
                const direction = trade.direction || 'unknown'
                const pnl = trade.finalPNL || 0
                const profitClass = pnl >= 0 ? 'positive' : 'negative'
                const timeAgo = getTimeAgo(new Date(trade.closedAt))
                
                return `
                    <div class="recent-move-item">
                        <div class="move-icon">${direction === 'long' ? '📈' : '📉'}</div>
                        <div class="move-info">
                            <div class="move-title">${asset} ${direction.toUpperCase()}</div>
                            <div class="move-time">${timeAgo}</div>
                        </div>
                        <div class="move-value ${profitClass}">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}</div>
                    </div>
                `
            }).join('')
        }
        
        function updateBestTrade(trades) {
            const container = document.getElementById('bestTradeCard')
            if (!container) return
            
            const todayTrades = trades.filter(t => {
                const tradeDate = new Date(t.closedAt).toDateString()
                const today = new Date().toDateString()
                return tradeDate === today
            })
            
            if (todayTrades.length === 0) {
                container.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 1rem;">Нет сделок сегодня</div>'
                return
            }
            
            const bestTrade = todayTrades.reduce((best, current) => 
                (current.finalPNL > best.finalPNL) ? current : best
            )
            
            const profitClass = bestTrade.finalPNL >= 0 ? 'positive' : 'negative'
            
            container.innerHTML = `
                <div class="best-trade-header">
                    <span class="best-trade-asset">${bestTrade.asset}</span>
                    <span class="best-trade-profit ${profitClass}">${bestTrade.finalPNL >= 0 ? '+' : ''}$${bestTrade.finalPNL.toFixed(2)}</span>
                </div>
                <div class="best-trade-details">
                    <span>${bestTrade.direction === 'long' ? 'LONG' : 'SHORT'}</span>
                    <span>Вход: $${bestTrade.entryPrice.toFixed(2)}</span>
                    <span>Выход: $${bestTrade.exitPrice.toFixed(2)}</span>
                </div>
            `
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000)
            
            if (seconds < 60) return 'только что'
            if (seconds < 3600) return `${Math.floor(seconds / 60)} мин назад`
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} ч назад`
            return `${Math.floor(seconds / 86400)} дн назад`
        }
        
        function switchAsset(asset) {
            console.log('🔄 Переключение на актив:', asset)
            
            currentAsset = asset
            
            document.querySelectorAll('.asset-btn').forEach(btn => {
                btn.classList.remove('active')
                if (btn.textContent.trim() === asset) {
                    btn.classList.add('active')
                }
            })
            
            currentPrice = currentPrices[asset]
            const priceEl = document.getElementById('currentPrice')
            if (priceEl) priceEl.textContent = '$' + currentPrice.toFixed(2)
            
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval)
                priceUpdateInterval = null
            }
            
            initTerminal()
        }
        
        function switchToTerminal() {
            console.log('▶️ ПЕРЕХОД В ТЕРМИНАЛ')
            
            document.querySelectorAll('.nav-item-vertical').forEach(i => i.classList.remove('active'))
            document.querySelectorAll('.nav-item-vertical')[1].classList.add('active')
            
            document.querySelectorAll('.section-container').forEach(s => s.classList.remove('active'))
            document.getElementById('terminal-section').classList.add('active')
            
            setTimeout(() => {
                initTerminal()
            }, 300)
        }
        
        function switchToTrainer() {
            console.log('▶️ ПЕРЕХОД В ТРЕНАЖЕР')
            
            document.querySelectorAll('.nav-item-vertical').forEach(i => i.classList.remove('active'))
            document.querySelectorAll('.nav-item-vertical')[2].classList.add('active')
            
            document.querySelectorAll('.section-container').forEach(s => s.classList.remove('active'))
            document.getElementById('trainer-section').classList.add('active')
            
            setTimeout(() => {
                loadNextTraining()
            }, 300)
        }
        
        function calculatePosition() {
            const size = parseFloat(document.getElementById('tradeSize').value) || 0
            const sl = parseFloat(document.getElementById('stopLoss').value)
            const tp = parseFloat(document.getElementById('takeProfit').value)
            
            const margin = size / currentLeverage
            const marginEl = document.getElementById('marginRequired')
            if (marginEl) marginEl.textContent = '$' + margin.toFixed(2)
            
            const positionSize = size * currentLeverage
            const sizeEl = document.getElementById('positionSize')
            if (sizeEl) sizeEl.textContent = '$' + positionSize.toFixed(2)
            
            if (sl) {
                const loss = Math.abs(currentPrice - sl) * (size / currentPrice)
                const lossEl = document.getElementById('potentialLoss')
                if (lossEl) lossEl.textContent = '$' + loss.toFixed(2)
            }
            
            if (tp) {
                const profit = Math.abs(tp - currentPrice) * (size / currentPrice)
                const profitEl = document.getElementById('potentialProfit')
                if (profitEl) profitEl.textContent = '$' + profit.toFixed(2)
            }
        }
        
        function setDirection(direction) {
            currentDirection = direction
            if (direction === 'long') {
                const longBtn = document.getElementById('longDirBtn')
                const shortBtn = document.getElementById('shortDirBtn')
                if (longBtn) longBtn.classList.add('active')
                if (shortBtn) shortBtn.classList.remove('active')
            } else {
                const longBtn = document.getElementById('longDirBtn')
                const shortBtn = document.getElementById('shortDirBtn')
                if (longBtn) longBtn.classList.remove('active')
                if (shortBtn) shortBtn.classList.add('active')
            }
            calculatePosition()
        }
        
        function setLeverage(leverage) {
            currentLeverage = leverage
            document.querySelectorAll('.leverage-btn').forEach(btn => {
                btn.classList.remove('active')
            })
            event.target.classList.add('active')
            calculatePosition()
        }
        
        // ============================================
        // ОБУЧЕНИЕ
        // ============================================
        
        async function loadUserProgress() {
            if (!currentUser) return
            
            try {
                console.log('📚 Загружаем прогресс пользователя...')
                
                const { data: progress, error } = await supabaseClient
                    .from('lesson_progress')
                    .select('lesson_id')
                    .eq('user_id', currentUser.id)
                    .eq('completed', true)
                
                if (error) throw error
                
                completedLessons = new Set(progress?.map(p => p.lesson_id) || [])
                console.log('✅ Загружено пройденных уроков:', completedLessons.size)
                
            } catch (error) {
                console.error('❌ Ошибка загрузки прогресса:', error)
                completedLessons = new Set()
            }
        }
        
        async function loadCourses() {
            console.log('📚 Функция loadCourses вызвана')
            const learningContent = document.getElementById('learningContent')
            
            if (!learningContent) return
            
            try {
                await loadUserProgress()
                
                const { data: courses, error } = await supabaseClient
                    .from('courses')
                    .select('*')
                    .order('created_at')
                
                if (error) throw error
                
                if (!courses || courses.length === 0) {
                    learningContent.innerHTML = `
                        <div style="text-align: center; padding: 4rem;">
                            <div style="font-size: 4rem; margin-bottom: 1rem;">📭</div>
                            <h3 style="margin-bottom: 0.5rem;">Пока нет курсов</h3>
                            <p style="color: var(--text-tertiary);">Скоро здесь появятся обучающие материалы</p>
                        </div>
                    `
                    return
                }
                
                const mainCourse = courses.find(c => c.is_main === true)
                const thematicCourses = courses.filter(c => c.is_main !== true)
                
                let html = ''
                
                if (mainCourse) {
                    const { data: chapters } = await supabaseClient
                        .from('chapters')
                        .select('id, lessons(id)')
                        .eq('course_id', mainCourse.id)
                    
                    let totalLessons = 0
                    let completedCount = 0
                    
                    if (chapters) {
                        const lessonIds = chapters.flatMap(ch => ch.lessons?.map(l => l.id) || [])
                        totalLessons = lessonIds.length
                        completedCount = lessonIds.filter(id => completedLessons.has(id)).length
                    }
                    
                    const progressPercent = totalLessons > 0 ? Math.round((completedCount / totalLessons) * 100) : 0
                    
                    html += `
                        <div class="main-course" onclick="openCourse(${mainCourse.id})" style="cursor: pointer;">
                            <h2>${mainCourse.title || 'Трейдинг от А до Я'}</h2>
                            <p>${mainCourse.description || 'Полный курс для начинающих трейдеров'}</p>
                            <div class="main-course-progress">
                                <div class="progress-header">
                                    <span>Прогресс</span>
                                    <span id="mainCourseProgress">${completedCount}/${totalLessons} уроков · ${progressPercent}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="mainCourseProgressBar" style="width: ${progressPercent}%;"></div>
                                </div>
                            </div>
                        </div>
                    `
                }
                
                if (thematicCourses.length > 0) {
                    html += '<h2 style="margin: 2rem 0 1.5rem;">Тематические курсы</h2>'
                    html += '<div class="thematic-grid">'
                    
                    for (const course of thematicCourses) {
                        const { data: chapters } = await supabaseClient
                            .from('chapters')
                            .select('id, lessons(id)')
                            .eq('course_id', course.id)
                        
                        const lessonCount = chapters?.reduce((sum, ch) => sum + (ch.lessons?.length || 0), 0) || 0
                        
                        html += `
                            <div class="thematic-card" onclick="openCourse(${course.id})">
                                <div class="thematic-icon">${course.icon || '📚'}</div>
                                <h3>${course.title || 'Без названия'}</h3>
                                <p>${course.description || 'Курс по трейдингу'}</p>
                                <div style="font-size: 0.8rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                    ${lessonCount} уроков
                                </div>
                            </div>
                        `
                    }
                    
                    html += '</div>'
                }
                
                learningContent.innerHTML = html
                
                const backBtn = document.getElementById('learningBackBtn')
                if (backBtn) backBtn.classList.add('hidden')
                
                currentCourse = null
                currentLesson = null
                
            } catch (error) {
                console.error('❌ Ошибка загрузки курсов:', error)
                learningContent.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--accent-3);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                        <div>Ошибка загрузки курсов</div>
                    </div>
                `
            }
        }
        
        async function openCourse(courseId) {
            console.log('📖 Открываем курс:', courseId)
            
            try {
                const { data: course, error: courseError } = await supabaseClient
                    .from('courses')
                    .select('*')
                    .eq('id', courseId)
                    .single()
                
                if (courseError) throw courseError
                
                const { data: chapters, error: chaptersError } = await supabaseClient
                    .from('chapters')
                    .select(`
                        id,
                        title,
                        description,
                        order_index,
                        lessons (
                            id,
                            title,
                            duration_minutes,
                            order_index,
                            price_tier
                        )
                    `)
                    .eq('course_id', courseId)
                    .order('order_index')
                
                if (chaptersError) throw chaptersError
                
                currentCourse = { ...course, chapters: chapters || [] }
                showCoursePage()
                
            } catch (error) {
                console.error('Ошибка открытия курса:', error)
                alert('Не удалось загрузить курс')
            }
        }
        
        function showCoursePage() {
            if (!currentCourse) return
            
            console.log('📖 Показываем страницу курса:', currentCourse.title)
            
            const backBtn = document.getElementById('learningBackBtn')
            if (backBtn) backBtn.classList.remove('hidden')
            
            const userTier = currentUser?.subscription_tier || 'free'
            
            let chaptersHtml = '<div class="chapters-list">'
            
            for (const chapter of currentCourse.chapters || []) {
                let lessonsHtml = '<div class="lessons-list">'
                
                for (const lesson of chapter.lessons || []) {
                    const hasAccess = userTier === 'pro' || 
                                     (userTier === 'trader' && lesson.price_tier !== 'pro') ||
                                     lesson.price_tier === 'free'
                    
                    const isCompleted = completedLessons.has(lesson.id)
                    const completedClass = isCompleted ? 'completed' : ''
                    const lockIcon = !hasAccess ? '🔒' : (isCompleted ? '✅' : '📘')
                    
                    lessonsHtml += `
                        <div class="lesson-item ${hasAccess ? '' : 'locked'} ${completedClass}" 
                             ${hasAccess ? `onclick="openLesson(${lesson.id})"` : ''}>
                            <div class="lesson-info">
                                <span class="lesson-icon">${lockIcon}</span>
                                <div>
                                    <div class="lesson-title">${lesson.title}</div>
                                    ${lesson.duration_minutes ? `<div class="lesson-meta">⏱ ${lesson.duration_minutes} мин</div>` : ''}
                                </div>
                            </div>
                            ${lesson.price_tier !== 'free' ? `
                                <span class="lesson-badge">${lesson.price_tier}</span>
                            ` : ''}
                            ${isCompleted ? '<span class="completed-badge">✓</span>' : ''}
                        </div>
                    `
                }
                
                lessonsHtml += '</div>'
                
                chaptersHtml += `
                    <div class="chapter-card">
                        <h3 class="chapter-title">${chapter.title}</h3>
                        ${chapter.description ? `<p class="chapter-description">${chapter.description}</p>` : ''}
                        ${lessonsHtml}
                    </div>
                `
            }
            
            chaptersHtml += '</div>'
            
            const learningContent = document.getElementById('learningContent')
            if (learningContent) {
                learningContent.innerHTML = `
                    <div>
                        <h1 class="course-title">${currentCourse.icon || '📚'} ${currentCourse.title}</h1>
                        <p class="course-description">${currentCourse.description || 'Курс по трейдингу'}</p>
                        
                        ${chaptersHtml || '<p style="color: var(--text-tertiary); text-align: center;">В этом курсе пока нет глав</p>'}
                    </div>
                `
            }
        }
        
        async function openLesson(lessonId) {
            console.log('📖 Открываем урок:', lessonId)
            
            try {
                const { data: lesson, error } = await supabaseClient
                    .from('lessons')
                    .select('*')
                    .eq('id', lessonId)
                    .single()
                
                if (error) throw error
                
                const { data: markdownFile, error: fileError } = await supabaseClient
                    .storage
                    .from('course-content')
                    .download(lesson.markdown_path)
                
                if (fileError) throw fileError
                
                const markdownText = await markdownFile.text()
                const htmlContent = marked.parse(markdownText)
                
                currentLesson = lesson
                const isCompleted = completedLessons.has(lesson.id)
                
                showLessonPage(lesson, htmlContent, isCompleted)
                
            } catch (error) {
                console.error('Ошибка загрузки урока:', error)
                alert('Не удалось загрузить урок')
            }
        }
        
        function showLessonPage(lesson, content, isCompleted = false) {
            console.log('📖 Показываем страницу урока:', lesson.title)
            
            const learningContent = document.getElementById('learningContent')
            if (learningContent) {
                const completeButton = isCompleted 
                    ? `<button class="mark-complete-btn completed" disabled>✅ Уже пройден</button>`
                    : `<button class="mark-complete-btn" onclick="markLessonCompleted(${lesson.id})">
                        ✅ Отметить как пройденный (+50 XP)
                       </button>`
                
                learningContent.innerHTML = `
                    <div>
                        <h1 class="course-title">📖 ${lesson.title}</h1>
                        ${lesson.duration_minutes ? `<p class="course-description">⏱ ${lesson.duration_minutes} минут</p>` : ''}
                        
                        <div class="lesson-content">
                            ${content}
                        </div>
                        
                        ${completeButton}
                    </div>
                `
            }
        }
        
        function showCoursesList() {
            console.log('📚 Возврат к списку курсов')
            loadCourses()
        }
        
        async function markLessonCompleted(lessonId) {
            if (!currentUser) {
                alert('Войдите в систему, чтобы отмечать прогресс')
                return
            }
            
            if (completedLessons.has(lessonId)) {
                showNotification('Уже пройдено', 'Этот урок уже отмечен как пройденный', 'warning')
                return
            }
            
            try {
                const { data: existing, error: checkError } = await supabaseClient
                    .from('lesson_progress')
                    .select('id')
                    .eq('user_id', currentUser.id)
                    .eq('lesson_id', lessonId)
                    .maybeSingle()
                
                if (checkError) throw checkError
                
                let result
                if (existing) {
                    result = await supabaseClient
                        .from('lesson_progress')
                        .update({ 
                            completed: true,
                            completed_at: new Date().toISOString()
                        })
                        .eq('id', existing.id)
                } else {
                    result = await supabaseClient
                        .from('lesson_progress')
                        .insert({
                            user_id: currentUser.id,
                            lesson_id: lessonId,
                            completed: true,
                            completed_at: new Date().toISOString()
                        })
                }
                
                if (result.error) throw result.error
                
                completedLessons.add(lessonId)
                
                await updateUserStats(currentUser.id, true, 50)
                await checkAchievements()
                
                showNotification('Урок пройден!', '+50 XP', 'success', '📚')
                
                await loadUserProfile()
                
                if (currentCourse) {
                    showCoursePage()
                }
                
                await loadCourses()
                
            } catch (error) {
                console.error('Ошибка отметки урока:', error)
                alert('Не удалось отметить урок: ' + error.message)
            }
        }
        
        // ============================================
        // ДОСТИЖЕНИЯ
        // ============================================
        
        async function loadAchievements() {
            if (!currentUser) return
            
            try {
                console.log('🏆 Загружаем достижения для пользователя:', currentUser.id)
                
                const { data: all, error: allError } = await supabaseClient
                    .from('achievements')
                    .select('*')
                
                if (allError) {
                    console.error('❌ Ошибка загрузки списка достижений:', allError)
                    return
                }
                
                const { data: user, error: userError } = await supabaseClient
                    .from('user_achievements')
                    .select('*')
                    .eq('user_id', currentUser.id)
                
                if (userError) {
                    console.error('❌ Ошибка загрузки достижений пользователя:', userError)
                    return
                }
                
                allAchievements = all || []
                userAchievements = user || []
                
                console.log(`🏆 Всего достижений: ${allAchievements.length}, получено: ${userAchievements.length}`)
                
                const metricAchievements = document.getElementById('metricAchievements')
                if (metricAchievements) metricAchievements.textContent = userAchievements.length
                
                const profileAchievementsCount = document.getElementById('profileAchievementsCount')
                if (profileAchievementsCount) profileAchievementsCount.textContent = userAchievements.length
                
                await loadAchievementsToProfile()
                
            } catch (error) {
                console.error('❌ Ошибка в loadAchievements:', error)
            }
        }
        
        async function loadAchievementsToProfile() {
            const container = document.getElementById('profileAchievementsGrid')
            if (!container) return
            
            try {
                if (!userAchievements || userAchievements.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-tertiary); text-align: center; padding: 2rem; grid-column: span 4;">У вас пока нет достижений</div>'
                    return
                }
                
                const achievementIds = userAchievements.map(ua => ua.achievement_id)
                
                const { data: achievementsData, error: achError } = await supabaseClient
                    .from('achievements')
                    .select('*')
                    .in('id', achievementIds)
                
                if (achError) {
                    console.error('❌ Ошибка загрузки данных достижений:', achError)
                    return
                }
                
                const achievementsMap = {}
                achievementsData.forEach(a => {
                    achievementsMap[a.id] = a
                })
                
                let html = ''
                
                for (const ua of userAchievements) {
                    const achievement = achievementsMap[ua.achievement_id]
                    if (!achievement) continue
                    
                    html += `
                        <div class="achievement-square earned">
                            <div class="achievement-icon">${achievement.icon || '🏆'}</div>
                            <div class="achievement-name">${achievement.title}</div>
                            <div class="achievement-tooltip">
                                <div class="tooltip-title">${achievement.title}</div>
                                <div class="tooltip-desc">${achievement.description}</div>
                                <div class="tooltip-xp">+${achievement.xp_reward} XP</div>
                                <div class="tooltip-date">✅ Получено: ${new Date(ua.earned_at).toLocaleDateString('ru-RU')}</div>
                            </div>
                        </div>
                    `
                }
                
                container.innerHTML = html
                
            } catch (error) {
                console.error('❌ Ошибка загрузки достижений в профиль:', error)
                container.innerHTML = '<div style="color: var(--accent-3); text-align: center; padding: 2rem; grid-column: span 4;">Ошибка загрузки достижений</div>'
            }
        }
        
        async function checkAchievements() {
            if (!currentUser) return
            
            try {
                console.log('🏆 Проверяем достижения...')
                
                const { error } = await supabaseClient.rpc('check_achievements', {
                    target_user_id: currentUser.id
                })
                
                if (error) {
                    console.error('Ошибка при проверке достижений:', error)
                } else {
                    const oldCount = userAchievements.length
                    await loadAchievements()
                    
                    if (userAchievements.length > oldCount) {
                        await checkNewAchievements()
                    }
                }
                
            } catch (error) {
                console.error('❌ Ошибка в checkAchievements:', error)
            }
        }
        
        async function checkNewAchievements() {
            const fiveSecondsAgo = new Date(Date.now() - 5000).toISOString()
            
            const { data: newAchievements } = await supabaseClient
                .from('user_achievements')
                .select('*')
                .eq('user_id', currentUser.id)
                .gte('earned_at', fiveSecondsAgo)
            
            if (newAchievements && newAchievements.length > 0) {
                const achievementIds = newAchievements.map(ua => ua.achievement_id)
                
                const { data: achievementsData } = await supabaseClient
                    .from('achievements')
                    .select('*')
                    .in('id', achievementIds)
                
                const achievementsMap = {}
                achievementsData.forEach(a => {
                    achievementsMap[a.id] = a
                })
                
                newAchievements.forEach(ua => {
                    const achievement = achievementsMap[ua.achievement_id]
                    if (achievement) {
                        showNotification(
                            'Новое достижение!', 
                            `${achievement.title} +${achievement.xp_reward} XP`, 
                            'achievement', 
                            achievement.icon
                        )
                    }
                })
            }
        }
        
        function openAchievementsModal() {
            const modal = document.getElementById('achievementsModal')
            if (!modal) return
            
            const container = document.getElementById('achievementsContainer')
            
            if (!allAchievements || allAchievements.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem;">Нет доступных достижений</div>'
                modal.classList.add('active')
                return
            }
            
            const earnedIds = new Set(userAchievements.map(ua => ua.achievement_id))
            
            const categories = {
                'Первые шаги': ['Первая кровь', 'Профит 100', 'Х100'],
                'Серии': ['Снайпер', 'Легенда', 'Бог рынка'],
                'Объемы': ['Кит', 'Акула', 'Кракен'],
                'Тренировки': ['Новичок', 'Аналитик', 'Профессор'],
                'Точность': ['Точность', 'Снайпер', 'Ясновидящий', 'Оракул'],
                'Учеба': ['Прилежный ученик', 'Зубрила', 'Библиотекарь', 'Мудрец'],
                'Ежедневки': ['Новичок недели', 'Недельный воин', 'Месячный легионер', 'Железный трейдер'],
                'Социальные': ['Душа компании', 'Популярный', 'Звезда', 'Инфлюенсер'],
                'Специальные': ['Богатенький Буратино', 'Лудоман', 'Хомяк', 'Полуночник', 'Консерватор', 'Рисковый'],
                'Скрытые': ['Счастливчик', 'Матрица', 'Терминатор']
            }
            
            let html = ''
            
            for (const [category, titles] of Object.entries(categories)) {
                const categoryAchievements = allAchievements.filter(a => titles.includes(a.title))
                
                if (categoryAchievements.length === 0) continue
                
                html += `<div class="achievements-category"><h3>${category}</h3><div class="achievements-grid">`
                
                for (const achievement of categoryAchievements) {
                    const earned = earnedIds.has(achievement.id)
                    
                    html += `
                        <div class="achievement-square ${earned ? 'earned' : ''}">
                            <div class="achievement-icon">${achievement.icon || '🏆'}</div>
                            <div class="achievement-name">${achievement.title}</div>
                            <div class="achievement-tooltip">
                                <div class="tooltip-title">${achievement.title}</div>
                                <div class="tooltip-desc">${achievement.description}</div>
                                <div class="tooltip-xp">+${achievement.xp_reward} XP</div>
                                ${earned ? `
                                    <div class="tooltip-date">✅ Получено</div>
                                ` : `
                                    <div class="tooltip-progress">🔒 Еще не получено</div>
                                `}
                            </div>
                        </div>
                    `
                }
                
                html += '</div></div>'
            }
            
            container.innerHTML = html
            modal.classList.add('active')
        }
        
        function closeAchievementsModal() {
            const modal = document.getElementById('achievementsModal')
            if (modal) modal.classList.remove('active')
        }
        
        // ============================================
        // ОБНОВЛЕНИЕ СТАТИСТИКИ ПОЛЬЗОВАТЕЛЯ
        // ============================================
        async function updateUserStats(userId, isCorrect, xpEarned) {
            if (!userId) return
            
            try {
                const { data: profile, error: getError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single()
                
                if (getError) return
                if (!profile) return
                
                const trainingsCount = (profile.trainings_count || 0) + 1
                const correctPredictions = (profile.correct_predictions || 0) + (isCorrect ? 1 : 0)
                const newXp = (profile.xp || 0) + xpEarned
                const newLevel = Math.floor(newXp / 1000) + 1
                const accuracy = trainingsCount > 0 ? (correctPredictions / trainingsCount * 100) : 0
                
                await supabaseClient
                    .from('profiles')
                    .update({
                        trainings_count: trainingsCount,
                        correct_predictions: correctPredictions,
                        xp: newXp,
                        level: newLevel,
                        accuracy: accuracy,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId)
                
            } catch (error) {
                console.error('❌ Ошибка в updateUserStats:', error)
            }
        }
        
        // ============================================
        // ЗАГРУЗКА ДАННЫХ ДЛЯ ДАШБОРДА
        // ============================================
        async function loadDashboardData() {
            try {
                const { data: charts, error } = await supabaseClient
                    .from('charts')
                    .select('*')
                    .limit(6)
                
                const countEl = document.getElementById('chartsCount')
                if (countEl) countEl.textContent = `${charts?.length || 0} доступно`
                
            } catch (error) {
                console.log('Ошибка загрузки дашборда:', error)
            }
        }
        
        // ============================================
        // ПРОФИЛЬ
        // ============================================
        
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatarInput')
            const file = fileInput?.files[0]
            if (!file || !currentUser) {
                alert('❌ Выберите файл')
                return
            }
            
            if (file.size > 2 * 1024 * 1024) {
                alert('❌ Файл слишком большой. Максимальный размер 2MB')
                return
            }
            
            if (!file.type.startsWith('image/')) {
                alert('❌ Можно загружать только изображения')
                return
            }
            
            try {
                const fileExt = file.name.split('.').pop()
                const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`
                
                const { data: uploadData, error: uploadError } = await supabaseClient
                    .storage
                    .from('avatars')
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: true
                    })
                
                if (uploadError) throw uploadError
                
                const { data: { publicUrl } } = supabaseClient
                    .storage
                    .from('avatars')
                    .getPublicUrl(fileName)
                
                await supabaseClient
                    .from('profiles')
                    .update({ avatar_url: publicUrl })
                    .eq('id', currentUser.id)
                
                await loadUserProfile()
                showNotification('Аватар обновлен', 'Фото профиля успешно изменено', 'success')
                
            } catch (error) {
                console.error('❌ Ошибка загрузки аватарки:', error)
                alert('❌ Не удалось загрузить аватарку')
            }
        }
        
        function copyInviteCode() {
            const codeEl = document.getElementById('inviteCode')
            if (!codeEl) return
            const code = codeEl.textContent
            navigator.clipboard.writeText(code)
            showNotification('Код скопирован', code, 'success')
        }
        
        async function updateBio() {
            const bioEl = document.getElementById('profileBio')
            if (!bioEl || !currentUser) return
            
            const bio = bioEl.value
            
            try {
                await supabaseClient
                    .from('profiles')
                    .update({ bio: bio })
                    .eq('id', currentUser.id)
                
                showNotification('Био обновлено', 'Информация сохранена', 'success')
                
            } catch (error) {
                console.error('Ошибка обновления био:', error)
            }
        }
        
        function editProfile() {
            const currentName = document.getElementById('profileFullName')?.textContent || ''
            const currentUsername = document.getElementById('profileUsername')?.textContent.replace('@', '') || ''
            const currentBio = document.getElementById('profileBio')?.value || ''
            
            const modal = document.createElement('div')
            modal.className = 'modal active'
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header">
                        <h3>Редактировать профиль</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">×</button>
                    </div>
                    <div style="padding: 1rem 0;">
                        <div class="form-group">
                            <label>Имя</label>
                            <input type="text" id="editName" class="trade-input" value="${currentName.replace(/[<>]/g, '')}">
                        </div>
                        <div class="form-group">
                            <label>Юзернейм</label>
                            <input type="text" id="editUsername" class="trade-input" value="${currentUsername.replace(/[<>]/g, '')}">
                        </div>
                        <div class="form-group">
                            <label>О себе</label>
                            <textarea id="editBio" class="trade-input" rows="3">${currentBio.replace(/[<>]/g, '')}</textarea>
                        </div>
                        <button class="auth-btn" onclick="saveProfile()" style="margin-top: 1rem;">
                            💾 Сохранить изменения
                        </button>
                    </div>
                </div>
            `
            document.body.appendChild(modal)
        }
        
        async function saveProfile() {
            const newName = document.getElementById('editName')?.value
            const newUsername = document.getElementById('editUsername')?.value
            const newBio = document.getElementById('editBio')?.value
            
            if (!newName || !newUsername) {
                alert('Имя и юзернейм обязательны')
                return
            }
            
            try {
                await supabaseClient
                    .from('profiles')
                    .update({ 
                        full_name: newName,
                        username: newUsername,
                        bio: newBio 
                    })
                    .eq('id', currentUser.id)
                
                document.querySelector('.modal.active')?.remove()
                await loadUserProfile()
                showNotification('Профиль обновлен', 'Изменения сохранены', 'success')
                
            } catch (error) {
                console.error('Ошибка сохранения:', error)
                alert('❌ Ошибка при сохранении')
            }
        }
        
        // ============================================
        // ДРУЗЬЯ - ИСПРАВЛЕННАЯ ВЕРСИЯ
        // ============================================
        
        async function loadFriends() {
            if (!currentUser) return
            
            try {
                console.log('👥 Загружаем друзей...')
                
                // Загружаем подтвержденных друзей (где ты отправил заявку и её приняли)
                const { data: accepted, error: acceptedError } = await supabaseClient
                    .from('friends')
                    .select('*, friend:friend_id(*)')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'accepted')
                
                if (acceptedError) console.error('Ошибка загрузки принятых заявок:', acceptedError)
                
                // Загружаем подтвержденных друзей (где тебя добавили в друзья и ты принял)
                const { data: accepted2, error: accepted2Error } = await supabaseClient
                    .from('friends')
                    .select('*, user:user_id(*)')
                    .eq('friend_id', currentUser.id)
                    .eq('status', 'accepted')
                
                if (accepted2Error) console.error('Ошибка загрузки принятых заявок (2):', accepted2Error)
                
                friends = [
                    ...(accepted?.map(f => ({ ...f.friend, friendship_id: f.id })) || []),
                    ...(accepted2?.map(f => ({ ...f.user, friendship_id: f.id })) || [])
                ]
                
                console.log('👥 Загружено друзей:', friends.length)
                
                // ЗАГРУЖАЕМ ВХОДЯЩИЕ ЗАЯВКИ (где тебя добавили в друзья, но ты ещё не ответил)
                const { data: requests, error: requestsError } = await supabaseClient
                    .from('friends')
                    .select('*, user:user_id(*)')
                    .eq('friend_id', currentUser.id)
                    .eq('status', 'pending')
                
                if (requestsError) {
                    console.error('❌ Ошибка загрузки заявок:', requestsError)
                } else {
                    friendRequests = requests?.map(r => ({ ...r.user, request_id: r.id })) || []
                    console.log('📨 Загружено входящих заявок:', friendRequests.length)
                    console.log('📨 Данные заявок:', friendRequests)
                }
                
                // ЗАГРУЖАЕМ ИСХОДЯЩИЕ ЗАЯВКИ (где ты добавил, но тебя ещё не приняли)
                const { data: sentRequests, error: sentError } = await supabaseClient
                    .from('friends')
                    .select('*, friend:friend_id(*)')
                    .eq('user_id', currentUser.id)
                    .eq('status', 'pending')
                
                if (sentError) {
                    console.error('❌ Ошибка загрузки исходящих заявок:', sentError)
                } else {
                    console.log('📤 Исходящих заявок:', sentRequests?.length || 0)
                }
                
                // Обновляем интерфейс в зависимости от текущей вкладки
                updateFriendsUI(currentFriendsTab || 'friends')
                
            } catch (error) {
                console.error('❌ Ошибка в loadFriends:', error)
            }
        }
        
        function switchFriendsTab(tab) {
            const tabs = document.querySelectorAll('.friends-tab')
            tabs.forEach(t => t.classList.remove('active'))
            event.target.classList.add('active')
            
            currentFriendsTab = tab
            updateFriendsUI(tab)
        }
        
        async function updateFriendsUI(tab = 'friends') {
            const container = document.getElementById('friendsContent')
            if (!container) return
            
            console.log('🔄 Обновляем вкладку:', tab)
            console.log('📨 Заявки для отображения:', friendRequests)
            
            if (tab === 'friends') {
                if (friends.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">👥</div>
                            <p>У вас пока нет друзей</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">Пригласите друзей по коду или найдите их по юзернейму</p>
                        </div>
                    `
                } else {
                    let html = '<div class="friends-list">'
                    
                    for (const friend of friends) {
                        html += `
                            <div class="friend-card">
                                <div class="friend-avatar">
                                    ${friend.avatar_url ? `<img src="${friend.avatar_url}">` : (friend.full_name?.charAt(0) || 'U')}
                                </div>
                                <div class="friend-info">
                                    <div class="friend-name">${friend.full_name || 'Пользователь'}</div>
                                    <div class="friend-username">@${friend.username || 'username'}</div>
                                    <div class="friend-stats">
                                        <span>Уровень ${friend.level || 1}</span>
                                        <span>${friend.trainings_count || 0} сделок</span>
                                    </div>
                                </div>
                                <div class="friend-actions">
                                    <button class="friend-btn remove" onclick="removeFriend('${friend.friendship_id}')">Удалить</button>
                                </div>
                            </div>
                        `
                    }
                    
                    html += '</div>'
                    container.innerHTML = html
                }
                
            } else if (tab === 'requests') {
                if (!friendRequests || friendRequests.length === 0) {
                    console.log('📭 Нет заявок для отображения')
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">📭</div>
                            <p>Нет входящих заявок</p>
                        </div>
                    `
                } else {
                    let html = '<div class="friends-list">'
                    
                    for (const request of friendRequests) {
                        console.log('📨 Отображаем заявку:', request)
                        html += `
                            <div class="friend-card">
                                <div class="friend-avatar">
                                    ${request.avatar_url ? `<img src="${request.avatar_url}">` : (request.full_name?.charAt(0) || 'U')}
                                </div>
                                <div class="friend-info">
                                    <div class="friend-name">${request.full_name || 'Пользователь'}</div>
                                    <div class="friend-username">@${request.username || 'username'}</div>
                                </div>
                                <div class="friend-actions">
                                    <button class="friend-btn accept" onclick="acceptFriendRequest('${request.request_id}')">✓ Принять</button>
                                    <button class="friend-btn decline" onclick="declineFriendRequest('${request.request_id}')">✕</button>
                                </div>
                            </div>
                        `
                    }
                    
                    html += '</div>'
                    container.innerHTML = html
                }
                
            } else if (tab === 'search') {
                container.innerHTML = `
                    <div class="friends-search">
                        <input type="text" id="friendSearchInput" placeholder="Введите юзернейм...">
                        <button onclick="searchUsers()">Найти</button>
                    </div>
                    <div id="searchResults" class="friends-list"></div>
                `
                
            } else if (tab === 'race') {
                await loadLeaderboard()
            }
        }
        
        async function searchUsers() {
            const query = document.getElementById('friendSearchInput')?.value
            if (!query || !currentUser) return
            
            try {
                const { data: users } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .ilike('username', `%${query}%`)
                    .neq('id', currentUser.id)
                    .limit(10)
                
                const container = document.getElementById('searchResults')
                
                if (!users || users.length === 0) {
                    container.innerHTML = '<div class="empty-state">Ничего не найдено</div>'
                    return
                }
                
                let html = ''
                
                for (const user of users) {
                    const { data: existing } = await supabaseClient
                        .from('friends')
                        .select('*')
                        .or(`and(user_id.eq.${currentUser.id},friend_id.eq.${user.id}),and(user_id.eq.${user.id},friend_id.eq.${currentUser.id})`)
                        .maybeSingle()
                    
                    let actionButton = ''
                    if (existing) {
                        if (existing.status === 'pending') {
                            actionButton = '<button class="friend-btn" disabled>Заявка отправлена</button>'
                        } else if (existing.status === 'accepted') {
                            actionButton = '<button class="friend-btn" disabled>✓ В друзьях</button>'
                        }
                    } else {
                        actionButton = `<button class="friend-btn add" onclick="sendFriendRequest('${user.id}')">+ Добавить</button>`
                    }
                    
                    html += `
                        <div class="friend-card">
                            <div class="friend-avatar">
                                ${user.avatar_url ? `<img src="${user.avatar_url}">` : (user.full_name?.charAt(0) || 'U')}
                            </div>
                            <div class="friend-info">
                                <div class="friend-name">${user.full_name || 'Пользователь'}</div>
                                <div class="friend-username">@${user.username || 'username'}</div>
                            </div>
                            <div class="friend-actions">
                                ${actionButton}
                            </div>
                        </div>
                    `
                }
                
                container.innerHTML = html
                
            } catch (error) {
                console.error('❌ Ошибка поиска:', error)
            }
        }
        
        async function sendFriendRequest(friendId) {
            if (!currentUser) return
            
            try {
                await supabaseClient
                    .from('friends')
                    .insert({
                        user_id: currentUser.id,
                        friend_id: friendId,
                        status: 'pending'
                    })
                
                showNotification('Заявка отправлена', 'Ожидайте подтверждения', 'success')
                searchUsers()
                
            } catch (error) {
                console.error('❌ Ошибка отправки заявки:', error)
            }
        }
        
        async function acceptFriendRequest(requestId) {
            try {
                await supabaseClient
                    .from('friends')
                    .update({ status: 'accepted' })
                    .eq('id', requestId)
                
                showNotification('Заявка принята', 'Теперь вы друзья', 'success')
                await loadFriends()
                switchFriendsTab('requests')
                
            } catch (error) {
                console.error('❌ Ошибка принятия заявки:', error)
            }
        }
        
        async function declineFriendRequest(requestId) {
            try {
                await supabaseClient
                    .from('friends')
                    .delete()
                    .eq('id', requestId)
                
                showNotification('Заявка отклонена', '', 'warning')
                await loadFriends()
                switchFriendsTab('requests')
                
            } catch (error) {
                console.error('❌ Ошибка отклонения заявки:', error)
            }
        }
        
        async function removeFriend(friendshipId) {
            if (!confirm('Удалить из друзей?')) return
            
            try {
                await supabaseClient
                    .from('friends')
                    .delete()
                    .eq('id', friendshipId)
                
                showNotification('Друг удален', '', 'warning')
                await loadFriends()
                switchFriendsTab('friends')
                
            } catch (error) {
                console.error('❌ Ошибка удаления друга:', error)
            }
        }
        
        async function loadLeaderboard() {
            const container = document.getElementById('friendsContent')
            if (!container) return
            
            try {
                const friendIds = friends.map(f => f.id)
                friendIds.push(currentUser.id)
                
                const { data: profiles } = await supabaseClient
                    .from('profiles')
                    .select('id, full_name, username, avatar_url, level, xp, trainings_count, accuracy, streak_days')
                    .in('id', friendIds)
                
                if (!profiles || profiles.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">🏃</div>
                            <p>Пригласите друзей для участия в забеге</p>
                        </div>
                    `
                    return
                }
                
                const sorted = profiles.sort((a, b) => (b.xp || 0) - (a.xp || 0))
                
                let html = `
                    <div class="race-header">
                        <h3>Турнирная таблица</h3>
                        <span class="race-period">Эта неделя</span>
                    </div>
                    <div class="leaderboard">
                        <div class="leaderboard-header">
                            <span>Место</span>
                            <span>Участник</span>
                            <span>XP</span>
                            <span>Сделки</span>
                        </div>
                `
                
                sorted.forEach((user, index) => {
                    const isCurrentUser = user.id === currentUser.id
                    const rankClass = index === 0 ? 'rank-1' : (index === 1 ? 'rank-2' : (index === 2 ? 'rank-3' : ''))
                    
                    html += `
                        <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}" onclick="viewFriendProfile('${user.id}')">
                            <span class="rank ${rankClass}">#${index + 1}</span>
                            <div class="user-info">
                                <div class="user-avatar-small">
                                    ${user.avatar_url ? `<img src="${user.avatar_url}">` : (user.full_name?.charAt(0) || 'U')}
                                </div>
                                <div>
                                    <div class="user-name">${user.full_name || 'Пользователь'} ${isCurrentUser ? '(Вы)' : ''}</div>
                                    <div class="user-username">@${user.username || 'username'}</div>
                                </div>
                            </div>
                            <span class="stat-value accent">${user.xp || 0} XP</span>
                            <span class="stat-value">${user.trainings_count || 0}</span>
                        </div>
                    `
                })
                
                html += '</div>'
                container.innerHTML = html
                
            } catch (error) {
                console.error('❌ Ошибка загрузки турнирной таблицы:', error)
            }
        }
        
        function viewFriendProfile(userId) {
            console.log('Просмотр профиля друга:', userId)
        }
        
        function inviteFriend() {
            const code = document.getElementById('inviteCode')?.textContent
            if (!code) return
            
            navigator.clipboard.writeText(code)
            showNotification('Код скопирован', 'Отправьте его другу', 'success')
        }
        
        function debugFriends() {
            console.log('👥 Друзья:', friends)
            console.log('📨 Входящие заявки:', friendRequests)
            console.log('📤 Текущая вкладка:', currentFriendsTab)
        }
        
        // ============================================
        // НАВИГАЦИЯ
        // ============================================
        function switchSection(section) {
            document.querySelectorAll('.nav-item-vertical').forEach(item => {
                item.classList.remove('active')
            })
            event.currentTarget.classList.add('active')
            
            document.querySelectorAll('.section-container').forEach(s => {
                s.classList.remove('active')
            })
            
            const sectionEl = document.getElementById(section + '-section')
            if (sectionEl) sectionEl.classList.add('active')
            currentSection = section
            
            if (section === 'learning') {
                loadCourses()
            } else if (section === 'friends') {
                loadFriends()
                switchFriendsTab('friends')
            }
        }
        
        function switchToSection(section) {
            document.querySelectorAll('.nav-item-vertical').forEach(item => {
                item.classList.remove('active')
            })
            document.querySelectorAll('.nav-item-vertical').forEach(item => {
                const names = {
                    'dashboard': 'Дашборд',
                    'terminal': 'Терминал',
                    'trainer': 'Тренажер',
                    'learning': 'Обучение',
                    'friends': 'Дружеский',
                    'profile': 'Профиль'
                }
                if (item.textContent.includes(names[section])) {
                    item.classList.add('active')
                }
            })
            
            document.querySelectorAll('.section-container').forEach(s => {
                s.classList.remove('active')
            })
            
            const sectionEl = document.getElementById(section + '-section')
            if (sectionEl) sectionEl.classList.add('active')
            currentSection = section
        }
        
        function switchToDashboard() {
            switchToSection('dashboard')
        }
        
        function switchToLearning() {
            switchToSection('learning')
        }
        
        // ============================================
        // НАСТРОЙКИ
        // ============================================
        function openSettings() {
            const modal = document.getElementById('settingsModal')
            if (modal) modal.classList.add('active')
        }
        
        function closeSettings() {
            const modal = document.getElementById('settingsModal')
            if (modal) modal.classList.remove('active')
        }
        
        function setTheme(theme) {
            currentTheme = theme
            
            if (theme === 'light') {
                document.body.classList.add('light-theme')
            } else {
                document.body.classList.remove('light-theme')
            }
            
            if (tradingViewWidget) {
                tradingViewWidget.changeTheme(theme)
            }
            
            if (trainerAnimator) {
                trainerAnimator.drawCandles(0, trainerAnimator.currentIndex)
            }
            
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active')
            })
            event.target.classList.add('active')
        }
        
        function setLanguage(lang) {
            console.log('Язык изменен на:', lang)
        }
        
        async function logout() {
            try {
                await supabaseClient.auth.signOut()
                currentUser = null
                document.getElementById('mainInterface').classList.remove('active')
                document.getElementById('auth').classList.add('active')
                switchAuthTab('login')
                
                openPositions = []
                closedTrades = []
                virtualBalance = 10000
                allAchievements = []
                userAchievements = []
                friends = []
                friendRequests = []
                completedLessons = new Set()
                
            } catch (error) {
                console.error('Ошибка выхода:', error)
            }
        }
        
        window.onclick = function(event) {
            const settingsModal = document.getElementById('settingsModal')
            const achievementsModal = document.getElementById('achievementsModal')
            
            if (event.target === settingsModal) {
                closeSettings()
            }
            if (event.target === achievementsModal) {
                closeAchievementsModal()
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const slider = document.getElementById('candleSlider')
            if (slider) {
                slider.addEventListener('input', function(e) {
                    if (trainerAnimator) {
                        trainerAnimator.pause()
                        trainerAnimator.setIndex(parseInt(e.target.value))
                    }
                })
            }
        })
    </script>

</body>

</html>


